// src/core/medicalGuide.js - מנגנון המלצות טיפוליות משודרג 2.0

/**
 * מודול המלצות טיפוליות חכם
 * =========================
 * 
 * מודול זה מספק המלצות טיפוליות מותאמות אישית בהתאם לתלונה, 
 * גיל המטופל, סימפטומים ספציפיים ודגלים אדומים.
 * 
 * המטרה: ספק המלצות איכותיות שיעזרו למטופל ולצוות הרפואי
 * לטפל בבעיה באופן היעיל ביותר עם התייחסות לגורמי סיכון.
 */

const MedicalGuide = {
  /**
   * מאגר המלצות טיפוליות לפי סוגי תלונה
   * מבנה הנתונים הוא מילון שבו המפתח הוא סוג התלונה
   * והערך הוא אובייקט עם שלושה שדות:
   * 1. general - המלצות כלליות למצב
   * 2. specific - המלצות ספציפיות למצבים משניים
   * 3. redFlags - דגלים אדומים והתראות
   */
  recommendations: {
    "כאב ראש": {
      general: [
        "מנוחה בסביבה שקטה ומוארת באופן מעומעם",
        "שתייה מרובה (לפחות 8-10 כוסות מים ביום)",
        "נטילת משככי כאבים כמו פאראצטמול או איבופרופן לפי הצורך ובהתאם להנחיות היצרן"
      ],
      specific: {
        // המלצות ספציפיות בהתאם לסימפטומים נוספים
        "רגישות לאור": [
          "הימנעות מחשיפה לאור בוהק ושימוש במשקפי שמש",
          "כיסוי החלונות בוילונות מחשיכים"
        ],
        "בחילה": [
          "אכילת ארוחות קטנות ותכופות",
          "הימנעות ממזונות שומניים או מתובלים מדי"
        ],
        "לחץ": [
          "תרגילי נשימה והרפייה",
          "הימנעות ממצבי לחץ ככל שניתן"
        ],
        "מיגרנה": [
          "שכיבה בחדר חשוך ושקט",
          "שימוש בקומפרס קר על המצח",
          "הימנעות מגורמים ידועים שמעוררים מיגרנה"
        ]
      },
      redFlags: [
        "פנייה מיידית לרופא/ה אם הכאב חמור במיוחד או הופיע באופן פתאומי",
        "פנייה מיידית לרופא/ה אם הכאב מלווה בהקאות עקשניות",
        "פנייה דחופה למיון אם הכאב מלווה בבלבול, חולשה בצד אחד של הגוף או קשיי דיבור"
      ]
    },
    
    "כאב גרון": {
      general: [
        "שתייה מרובה של נוזלים פושרים (לפחות 8-10 כוסות ביום)",
        "גרגור עם מי מלח פושרים (כפית מלח בכוס מים) 3-4 פעמים ביום",
        "מנוחה קולית והפחתת דיבור",
        "לוזנג'ים להקלה מקומית או תרסיס גרון ייעודי",
        "נטילת משככי כאבים כמו פאראצטמול לפי הצורך"
      ],
      specific: {
        "חום": [
          "נטילת תרופות להורדת חום לפי הצורך",
          "מנוחה במיטה"
        ],
        "קושי בבליעה": [
          "אכילת מזונות רכים וקרים",
          "הימנעות ממזונות חריפים או קשים"
        ],
        "יובש בגרון": [
          "שימוש במכשיר אדים בחדר השינה",
          "שתיית תה עם דבש (לא לילדים מתחת לגיל שנה)"
        ]
      },
      redFlags: [
        "פנייה לרופא/ה אם כאב הגרון נמשך יותר מ-7 ימים",
        "פנייה לרופא/ה אם יש חום גבוה (מעל 38.3°C) למשך יותר מ-48 שעות",
        "פנייה דחופה לרופא/ה אם יש קושי משמעותי בבליעה או נשימה"
      ]
    },
    
    "כאב בטן": {
      general: [
        "מנוחה והימנעות ממאמץ פיזי",
        "שתייה מרובה של מים (לפחות 8 כוסות ביום)",
        "אכילת ארוחות קטנות ותכופות",
        "הימנעות ממזונות מתובלים, שומניים או מעובדים",
        "נטילת תרופות נוגדות כאב לפי הצורך ובהתאם להוראות היצרן"
      ],
      specific: {
        "שלשול": [
          "שתיית נוזלים המכילים אלקטרוליטים",
          "דיאטה קלה המורכבת מאורז, לחם, תפוחי עץ ובננות",
          "הימנעות ממוצרי חלב, קפאין ואלכוהול"
        ],
        "עצירות": [
          "הגברת צריכת סיבים תזונתיים",
          "שתייה מרובה",
          "פעילות גופנית קלה"
        ],
        "גזים": [
          "הימנעות ממזונות היוצרים גזים כמו כרוב, שעועית, בצל",
          "אכילה איטית תוך לעיסה ממושכת"
        ],
        "צרבת": [
          "אכילת ארוחות קטנות",
          "הימנעות משכיבה מיד לאחר האוכל",
          "הימנעות ממזונות חריפים, שומניים, קפאין וחומץ"
        ]
      },
      redFlags: [
        "פנייה מיידית לרופא/ה אם הכאב חזק מאוד או מתמקד בצד ימין תחתון של הבטן",
        "פנייה מיידית לרופא/ה אם הכאב מלווה בחום, הקאות מרובות או דם בצואה",
        "פנייה דחופה אם הבטן קשה למגע או נפוחה באופן משמעותי"
      ]
    },
    
    "כאב גב": {
      general: [
        "מנוחה והימנעות ממאמץ פיזי בימים הראשונים",
        "חימום האזור הכואב בעזרת בקבוק חם או מגבת חמה",
        "לאחר 48 שעות - שילוב של חימום וקירור לסירוגין",
        "שמירה על תנוחה נכונה בישיבה ובשכיבה",
        "נטילת משככי כאבים ונוגדי דלקת לפי הצורך ובהתאם להוראות היצרן"
      ],
      specific: {
        "גב תחתון": [
          "שכיבה על הגב עם כרית מתחת לברכיים",
          "הימנעות מישיבה ממושכת",
          "תרגילי מתיחה עדינים לשרירי הגב כשהכאב מתמתן"
        ],
        "גב עליון": [
          "שינויים ארגונומיים בסביבת העבודה",
          "מתיחות קלות לצוואר וכתפיים",
          "הימנעות מנשיאת משאות כבדים"
        ],
        "קרינה לרגל": [
          "תנוחות שמפחיתות לחץ על עצב הסיאטיק",
          "הימנעות מישיבה ממושכת",
          "תרגילי מתיחה ייעודיים כשמתאפשר"
        ]
      },
      redFlags: [
        "פנייה לרופא/ה אם הכאב חמור או לא משתפר לאחר 3-5 ימים של טיפול ביתי",
        "פנייה מיידית לרופא/ה אם יש חולשה ברגליים, קושי בשליטה בשתן או צואה",
        "פנייה דחופה אם הכאב התחיל לאחר פציעה משמעותית"
      ]
    },
    
    "כאב שרירים": {
      general: [
        "מנוחה של השריר הפגוע",
        "שימוש במשככי כאב כמו פאראצטמול או איבופרופן לפי הצורך",
        "מתיחות עדינות כשהכאב מתמתן",
        "שתייה מרובה לשמירה על הידרציה טובה"
      ],
      specific: {
        "כאב שרירים מפעילות גופנית": [
          "קירור בקרח ב-48 השעות הראשונות",
          "חימום לאחר מכן",
          "תרגילי מתיחה עדינים",
          "חזרה הדרגתית לפעילות"
        ],
        "כאבי שרירים כרוניים": [
          "פעילות גופנית מתונה וקבועה",
          "טכניקות הרפיה ומדיטציה",
          "טיפולי מסאז' מקצועיים"
        ],
        "התכווצויות שרירים": [
          "מתיחה עדינה של השריר המתכווץ",
          "שתיית נוזלים עם מינרלים",
          "הגברת צריכת מאכלים עשירים באשלגן ומגנזיום"
        ]
      },
      redFlags: [
        "פנייה לרופא אם כאבי השרירים מלווים בחום גבוה ובתפרחת עורית",
        "פנייה לרופא אם יש חולשת שרירים משמעותית",
        "פנייה דחופה אם מדובר בכאב חריף שהופיע לאחר פציעה משמעותית"
      ]
    },
    
    "כאב פרקים": {
      general: [
        "מנוחה מפעילות שמחמירה את הכאב",
        "קומפרסים קרים להפחתת נפיחות וחום",
        "נטילת משככי כאבים ונוגדי דלקת לפי הצורך",
        "שימוש בסד או תחבושת לייצוב הפרק"
      ],
      specific: {
        "כאב מפרקים כרוני": [
          "פעילות גופנית עדינה ומותאמת",
          "שמירה על משקל גוף תקין",
          "חיזוק שרירים סביב המפרק"
        ],
        "דלקת מפרקים": [
          "שילוב חום וקור לסירוגין",
          "פעילות גופנית מתונה במים",
          "הימנעות מפעילות בעומס גבוה על המפרק"
        ],
        "נוקשות פרקים": [
          "תרגילי טווח תנועה",
          "חימום הפרק לפני פעילות",
          "מתיחות עדינות יומיות"
        ]
      },
      redFlags: [
        "פנייה לרופא אם יש נפיחות משמעותית, אודם וחום",
        "פנייה לרופא אם הכאב מגביל תנועה באופן משמעותי",
        "פנייה דחופה אם הכאב מלווה בחום גבוה או הופיע אחרי פציעה"
      ]
    },
    
    "פציעת ספורט": {
      general: [
        "טיפול RICE - מנוחה (Rest), קרח (Ice), לחץ (Compression), הגבהה (Elevation)",
        "הנחת קרח על האזור הפגוע למשך 15-20 דקות, 3-4 פעמים ביום ב-48 השעות הראשונות",
        "שימוש בתחבושת אלסטית לייצוב ולחץ על האזור הפגוע",
        "הגבהת האזור הפגוע מעל גובה הלב כשניתן",
        "נטילת תרופות נוגדות דלקת וכאב לפי הצורך ובהתאם להוראות היצרן"
      ],
      specific: {
        "נקע": [
          "קיבוע והימנעות מהפעלת המפרק הפגוע",
          "שימוש בתחבושת אלסטית או מקבע למפרק",
          "הימנעות מפעילות גופנית הכוללת את המפרק הפגוע"
        ],
        "מתיחת שריר": [
          "מנוחה והימנעות מפעילות הגורמת לכאב",
          "מתיחות עדינות לאחר שהכאב החריף שוכך",
          "חזרה הדרגתית לפעילות"
        ],
        "חבלה": [
          "קרח לשליטה בנפיחות ודימום תת-עורי",
          "הימנעות מחימום באזור ב-48 השעות הראשונות"
        ],
        "פציעת שריר חוזרת": [
          "חיזוק השריר באופן הדרגתי לאחר החלמה",
          "קבלת הדרכה מקצועית לטכניקה נכונה",
          "תכנית אימונים מאוזנת עם מנוחה מספקת"
        ]
      },
      redFlags: [
        "פנייה מיידית לרופא/ה אם יש עיוות ברור באזור הפגוע",
        "פנייה לרופא/ה אם הכאב או הנפיחות לא משתפרים לאחר 3-5 ימים של טיפול ביתי",
        "פנייה דחופה אם יש אובדן תחושה או חולשה בגפה"
      ]
    },
    
    "פציעת שריר": {
      general: [
        "טיפול RICE - מנוחה, קרח, לחץ והגבהה",
        "הימנעות מפעילות גופנית המערבת את השריר הפגוע למשך 48-72 שעות",
        "קומפרסים קרים ב-48 השעות הראשונות, 15-20 דקות כל 2-3 שעות",
        "נטילת משככי כאבים ונוגדי דלקת לפי הצורך"
      ],
      specific: {
        "קרע שרירי קל": [
          "מנוחה יחסית למשך 1-2 שבועות",
          "מתיחות עדינות כשהכאב מתמתן",
          "חזרה הדרגתית לפעילות"
        ],
        "התכווצות שרירים": [
          "מתיחה עדינה של השריר המתכווץ",
          "שתייה מרובה והחזרת אלקטרוליטים",
          "מסאז' עדין לשריר"
        ],
        "מתיחת שריר": [
          "מנוחה של השריר למשך 24-48 שעות",
          "הימנעות מתנועות חדות ומתיחות אגרסיביות",
          "תרגילי טווח תנועה עדינים כשהכאב פוחת"
        ]
      },
      redFlags: [
        "פנייה לרופא אם ישנה נפיחות משמעותית שלא פוחתת",
        "פנייה לרופא אם יש שקע או בליטה ניכרים בשריר",
        "פנייה דחופה אם אין יכולת להזיז את הגפה או יש אובדן תחושה"
      ]
    },
    
    "פציעת רצועה": {
      general: [
        "טיפול RICE - מנוחה, קרח, לחץ והגבהה",
        "הימנעות מהעמסה על המפרק הפגוע",
        "קיבוע המפרק באמצעות תחבושת אלסטית או מקבע",
        "שימוש באמצעי עזר להליכה (קביים) במידת הצורך"
      ],
      specific: {
        "נקע קל": [
          "מנוחה למשך 24-72 שעות",
          "תרגילי טווח תנועה עדינים לאחר הפחתת הכאב",
          "חזרה הדרגתית לפעילות"
        ],
        "נקע בינוני": [
          "קיבוע ממושך יותר ומנוחה של 1-2 שבועות",
          "תרגילי חיזוק עדינים לאחר תקופת המנוחה",
          "שימוש בסד או תחבושת תומכת"
        ],
        "נקע חוזר": [
          "חיזוק השרירים התומכים במפרק",
          "עבודה על שיווי משקל ויציבות",
          "שימוש קבוע בתחבושת תומכת בפעילות גופנית"
        ]
      },
      redFlags: [
        "פנייה לרופא אם המפרק לא יציב או 'נשבר' תחת משקל",
        "פנייה לרופא אם יש נפיחות משמעותית שלא פוחתת אחרי 48 שעות",
        "פנייה דחופה אם נשמע קול נקישה או קריעה בזמן הפציעה"
      ]
    },
    
    "נקע": {
      general: [
        "טיפול RICE - מנוחה, קרח, לחץ והגבהה",
        "הימנעות מדריכה או העמסה על המפרק הפגוע",
        "קומפרסים קרים למשך 15-20 דקות כל 2-3 שעות בימים הראשונים",
        "שימוש בתחבושת אלסטית או מקבע למפרק"
      ],
      specific: {
        "נקע קרסול": [
          "הגבהת הרגל מעל גובה הלב בזמן מנוחה",
          "הימנעות מפעילויות הכוללות קפיצות, ריצה או שינויי כיוון",
          "תרגילי טווח תנועה עדינים כאשר הכאב פוחת"
        ],
        "נקע פרק כף היד": [
          "קיבוע כף היד במתלה או סד",
          "הגבהת כף היד מעל גובה הלב",
          "הימנעות מפעילויות הדורשות סיבוב או הפעלת כוח בכף היד"
        ],
        "נקע אצבע": [
          "קיבוע האצבע לאצבע סמוכה (קשירה)",
          "הימנעות מפעילויות הדורשות תפיסה חזקה",
          "תרגילי טווח תנועה עדינים לאחר הפחתת הכאב"
        ]
      },
      redFlags: [
        "פנייה לרופא אם המפרק לא יציב או 'נשבר' תחת משקל",
        "פנייה לרופא אם יש נפיחות משמעותית שלא פוחתת אחרי 48 שעות",
        "פנייה דחופה אם נשמע קול נקישה או קריעה בזמן הפציעה"
      ]
    },
    
    "דלקת גידים": {
      general: [
        "מנוחה מהפעילות שגורמת לכאב",
        "קומפרסים קרים על האזור הכואב למשך 15-20 דקות, 3-4 פעמים ביום",
        "שימוש במשככי כאב ונוגדי דלקת לפי הצורך",
        "הגבהת האזור הפגוע אם ניתן"
      ],
      specific: {
        "דלקת גיד אכילס": [
          "הגבהת העקב בעזרת מדרסים",
          "הימנעות מריצה ופעילויות שכוללות קפיצות",
          "מתיחות עדינות לשרירי השוק"
        ],
        "מרפק טניס": [
          "מנוחה מפעילויות הדורשות אחיזה או סיבוב של כף היד",
          "שימוש ברצועת תמיכה באמה",
          "תרגילי חיזוק עדינים לאחר שהכאב פוחת"
        ],
        "דלקת גידי כתף": [
          "הגבלת תנועות מעל גובה הכתף",
          "שימוש בקרח לאחר פעילות שגרמה לכאב",
          "תרגילי טווח תנועה עדינים כשהכאב פוחת"
        ]
      },
      redFlags: [
        "פנייה לרופא אם הכאב חמור ומגביל תנועה באופן משמעותי",
        "פנייה לרופא אם יש נפיחות, אודם וחום באזור",
        "פנייה דחופה אם יש חשד לקרע בגיד (כאב פתאומי חד עם חולשה)"
      ]
    },
    
    "קוצר נשימה": {
      general: [
        "ישיבה זקופה או עמידה להקלה על הנשימה",
        "נשימות איטיות ועמוקות דרך האף ונשיפה ארוכה דרך השפתיים",
        "הימנעות ממאמץ פיזי בזמן האפיזודה",
        "שהייה בסביבה עם אוויר נקי ולחות מתאימה"
      ],
      specific: {
        "קוצר נשימה בשל חרדה": [
          "תרגילי נשימה מבוקרים: שאיפה למשך 4 שניות, עצירה ל-2, נשיפה למשך 6",
          "טכניקות הרפיה כגון מדיטציה או הרפיית שרירים מתקדמת",
          "הסחת דעת על ידי התמקדות באובייקטים בסביבה"
        ],
        "קוצר נשימה בשל אסטמה": [
          "שימוש במשאף מרחיב סימפונות כפי שהומלץ על ידי הרופא",
          "הימנעות מגורמים מעוררים ידועים",
          "הקפדה על תוכנית טיפול מסודרת"
        ],
        "קוצר נשימה במאמץ": [
          "חימום הדרגתי לפני פעילות גופנית",
          "התאמת עצימות הפעילות ליכולת האישית",
          "תרגול נשימה נכונה בזמן פעילות"
        ]
      },
      redFlags: [
        "פנייה מיידית לטיפול רפואי אם קוצר הנשימה חמור או מחמיר במהירות",
        "פנייה מיידית לטיפול רפואי אם יש כחלון בשפתיים או בציפורניים",
        "פנייה דחופה אם קוצר הנשימה מלווה בכאבים בחזה או בקשיי דיבור"
      ]
    },
    
    "שיעול": {
      general: [
        "שתייה מרובה של נוזלים חמימים",
        "שימוש במכשיר אדים או מקלחת חמה להקלה על דרכי הנשימה",
        "מנוחה מספקת",
        "לוזנג'ים או תרופות להקלה על השיעול לפי הצורך"
      ],
      specific: {
        "שיעול יבש": [
          "שתיית תה עם דבש ולימון (לא לילדים מתחת לגיל שנה)",
          "הימנעות מאוויר יבש או קר",
          "שימוש במכשיר אדים בחדר השינה"
        ],
        "שיעול ליחתי": [
          "שתייה מרובה לדילול הליחה",
          "הימנעות מחלב ומוצריו שעלולים להגביר ייצור ליחה",
          "שמירה על הראש מוגבה בזמן השינה"
        ],
        "שיעול אלרגי": [
          "זיהוי וצמצום חשיפה לאלרגנים",
          "ניקוי הבית מאבק ואלרגנים אחרים",
          "שימוש בתרופות אנטי-היסטמיניות לפי המלצת רופא"
        ]
      },
      redFlags: [
        "פנייה לרופא אם השיעול מתמשך יותר מ-3 שבועות",
        "פנייה לרופא אם יש דם בליחה או ליחה בצבע ירוק/צהוב כהה",
        "פנייה דחופה אם השיעול מלווה בקוצר נשימה חמור או כאבים בחזה"
      ]
    },
    
    "סחרחורת": {
      general: [
        "ישיבה או שכיבה מיד עם הופעת הסחרחורת",
        "תנועות איטיות והימנעות מתנועות פתאומיות של הראש",
        "שתייה מרובה ואכילה סדירה",
        "מנוחה בסביבה שקטה"
      ],
      specific: {
        "סחרחורת מצבית": [
          "הימנעות משינויי תנוחה פתאומיים",
          "קימה הדרגתית ממצב שכיבה לישיבה ואז לעמידה",
          "תרגילי הסתגלות למצב שיווי משקל (אם הומלצו על ידי איש מקצוע)"
        ],
        "סחרחורת הקשורה לאוזן פנימית": [
          "תרגילי ברנדט-דרוף או אפלי אם הומלצו על ידי רופא",
          "הימנעות מתנועות ראש חדות",
          "זהירות בתנועה ובהליכה"
        ],
        "סחרחורת בשל התייבשות": [
          "שתייה מרובה של מים ומשקאות עם אלקטרוליטים",
          "אכילת ארוחות קטנות וקלות",
          "מנוחה בסביבה קרירה"
        ]
      },
      redFlags: [
        "פנייה לרופא אם הסחרחורת מתמשכת או חוזרת",
        "פנייה לרופא אם יש אובדן שמיעה, טנטון או כאב באוזניים",
        "פנייה דחופה אם הסחרחורת מלווה בכאב ראש חמור, בלבול, דיבור לא ברור או חולשה פתאומית בפנים או בגפיים"
      ]
    },
    
    "חום": {
      general: [
        "מנוחה רבה",
        "שתייה מרובה של נוזלים",
        "נטילת תרופות להורדת חום לפי הצורך ובהתאם להוראות היצרן",
        "לבוש קל ומאוורר"
      ],
      specific: {
        "חום גבוה מעל 38.5°C": [
          "קומפרסים קרים על המצח, בתי השחי והמפשעות",
          "מקלחת פושרת (לא קרה)",
          "נטילת משככי חום כפי שהומלץ"
        ],
        "חום עם שיעול": [
          "שתיית נוזלים חמים עם דבש ולימון",
          "מנוחה בחדר עם אדים",
          "הימנעות ממאכלים מגרים"
        ],
        "חום עם כאב גרון": [
          "גרגור במי מלח פושרים",
          "שתיית משקאות חמימים",
          "מנוחה קולית"
        ]
      },
      redFlags: [
        "פנייה לרופא אם החום גבוה מ-39.5°C או נמשך יותר מ-3 ימים",
        "פנייה לרופא אם החום מלווה בפריחה, כאב ראש חזק או קשיון עורף",
        "פנייה דחופה אם החום מלווה בבלבול, קשיי נשימה או כאב חזה"
      ]
    },
    
    "אלרגיה": {
      general: [
        "הימנעות מחשיפה לאלרגן הידוע אם אפשר",
        "נטילת אנטי-היסטמינים לפי הצורך ובהתאם להוראות היצרן",
        "שטיפת אף במי מלח אם יש נזלת אלרגית",
        "שמירה על סביבה נקייה מאבק ואלרגנים ביתיים"
      ],
      specific: {
        "אלרגיה עונתית": [
          "עקיבה אחר תחזיות פולן ותכנון פעילויות בהתאם",
          "הימנעות מיציאה החוצה בימים עם רמות פולן גבוהות",
          "שטיפת שיער וגוף אחרי שהייה בחוץ"
        ],
        "אלרגיה למזון": [
          "קריאת תוויות מזון בקפידה",
          "הודעה למסעדות או למארחים על האלרגיה",
          "נשיאת תרופות חירום (כגון EpiPen) אם נרשמו"
        ],
        "אלרגיה לחיות מחמד": [
          "הימנעות ממגע ישיר עם חיות",
          "שטיפת ידיים אחרי מגע עם חיות",
          "שימוש במסנני אוויר HEPA"
        ]
      },
      redFlags: [
        "פנייה דחופה לטיפול רפואי אם יש קשיי נשימה, נפיחות בפנים או בגרון",
        "פנייה דחופה לטיפול רפואי אם יש סימני הלם אלרגי (אנפילקסיס)",
        "שימוש באפיפן אם יש ונקיטת פעולה מיידית"
      ]
    },
    
    "פריחה בעור": {
      general: [
        "הימנעות מגירוד האזור הנגוע",
        "ניקוי עדין עם מים פושרים וסבון עדין",
        "שימוש בקרם לחות היפואלרגני",
        "שימוש בקומפרסים קרים להקלה על גירוי"
      ],
      specific: {
        "פריחה יבשה ומגרדת": [
          "שימוש בקרמים המכילים קורטיזון בריכוז נמוך (לפי הוראות)",
          "הימנעות מבגדים צמודים ומחומרים מגרים",
          "שמירה על לחות בחדר השינה"
        ],
        "פריחה אדומה עם נפיחות": [
          "קומפרסים קרים להפחתת נפיחות",
          "הימנעות מחשיפה לשמש",
          "שימוש בתכשירים אנטי-היסטמיניים לפי הצורך"
        ],
        "פריחה עם שלפוחיות": [
          "שמירה על ניקיון האזור",
          "הימנעות מפיצוץ השלפוחיות",
          "כיסוי עדין בתחבושת סטרילית אם יש צורך"
        ]
      },
      redFlags: [
        "פנייה לרופא אם הפריחה מתפשטת במהירות או מכסה שטח גדול",
        "פנייה לרופא אם יש חום או תחושת חולי כללית",
        "פנייה דחופה אם הפריחה מלווה בקשיי נשימה, נפיחות בפנים או בגרון"
      ]
    },
    
    // תבנית המלצה כללית לכל תלונה שאין לה המלצות ספציפיות
    "default": {
      general: [
        "מנוחה והפחתת פעילות גופנית מאומצת",
        "שתייה מרובה של נוזלים (8-10 כוסות מים ביום)",
        "נטילת משככי כאבים לפי הצורך ובהתאם להוראות היצרן",
        "חיפוש תמיכה רפואית אם הסימפטומים חמורים או נמשכים מעבר ל-3 ימים"
      ],
      specific: {},
      redFlags: [
        "פנייה לרופא/ה אם הסימפטומים מחמירים או לא משתפרים לאחר 3 ימים",
        "פנייה מיידית לרופא/ה אם מופיעים סימפטומים כמו חום גבוה, בלבול, קשיי נשימה או כאב חמור"
      ]
    }
  },
  
  /**
   * קבלת המלצות טיפוליות בהתאם לתלונה ולתשובות
   * @param {string} complaint - התלונה העיקרית
   * @param {object} patientRecord - רשומת המטופל עם התשובות לשאלות
   * @returns {object} - המלצות טיפוליות מותאמות אישית
   */
  getRecommendations: function(complaint, patientRecord) {
    // חיפוש במילון לפי שם התלונה המדויק
    let recommendationTemplate = this.recommendations[complaint];
    
    // אם לא נמצא, חיפוש חלקי (תת-מחרוזת)
    if (!recommendationTemplate) {
      const complaintKey = Object.keys(this.recommendations).find(key => 
        complaint.includes(key) || key.includes(complaint)
      );
      
      if (complaintKey) {
        recommendationTemplate = this.recommendations[complaintKey];
      } else {
        // אם עדיין לא נמצא - שימוש בהמלצות ברירת מחדל
        recommendationTemplate = this.recommendations["default"];
      }
    }
    
    // יצירת עותק של ההמלצות הכלליות
    const recommendations = {
      general: [...recommendationTemplate.general],
      specific: [],
      redFlags: [...recommendationTemplate.redFlags],
    };
    
    // הוספת המלצות ספציפיות בהתאם לתשובות המטופל
    if (recommendationTemplate.specific) {
      const allAnswers = { ...patientRecord.standardAnswers, ...patientRecord.dynamicAnswers };
      
      // בדיקת כל התשובות לחיפוש מצבים ספציפיים שדורשים המלצות מותאמות
      for (const [condition, conditionRecommendations] of Object.entries(recommendationTemplate.specific)) {
        if (this._answerMatchesCondition(allAnswers, condition)) {
          recommendations.specific.push({
            condition: condition,
            recommendations: conditionRecommendations
          });
        }
      }
    }
    
    // התאמה להיבטים דמוגרפיים - גיל
    if (patientRecord.patientInfo.age > 65) {
      recommendations.general.push("יש לשים לב במיוחד להידרדרות במצב ולדווח לרופא/ה בהקדם במקרה של החמרה");
    } else if (patientRecord.patientInfo.age < 12) {
      recommendations.general.push("יש להתאים את המינון של כל תרופה לפי גיל הילד ובהתאם להוראות הרופא או היצרן");
    }
    
    // התאמה לפרופיל רפואי (עישון)
    if (patientRecord.patientInfo.smoking === 'yes') {
      recommendations.general.push("מומלץ להימנע מעישון בתקופת ההחלמה שכן הוא עלול להחמיר את הסימפטומים");
    }
    
    // בדיקת דגלים אדומים על בסיס פונקציה חיצונית אם קיימת
    if (typeof MedicalDataSystem !== 'undefined' && typeof MedicalDataSystem.checkForRedFlags === 'function') {
      const redFlags = MedicalDataSystem.checkForRedFlags(patientRecord);
      if (redFlags && redFlags.length > 0) {
        // מוסיף דגלים אדומים ספציפיים שזוהו
        redFlags.forEach(flag => {
          if (!recommendations.redFlags.some(existingFlag => existingFlag.includes(flag))) {
            recommendations.redFlags.push(`פנייה דחופה לטיפול רפואי: ${flag}`);
          }
        });
      }
    }
    
    return recommendations;
  },
  
  /**
   * בדיקה אם התשובות מכילות התייחסות למצב מסוים
   * @private
   * @param {object} answers - אוסף התשובות
   * @param {string} condition - המצב שמחפשים
   * @returns {boolean} - האם התשובות מתייחסות למצב
   */
  _answerMatchesCondition: function(answers, condition) {
    // פיצול תנאי למילות מפתח
    const keywords = condition.toLowerCase().split(/\s+/);
    
    // בדיקת כל צמד שאלה-תשובה
    for (const [question, answer] of Object.entries(answers)) {
      if (!answer || typeof answer !== 'string') continue;
      
      // יצירת טקסט משולב של שאלה ותשובה לחיפוש מהיר
      const combinedText = (question + " " + answer).toLowerCase();
      
      // בדיקה אם כל מילות המפתח מופיעות
      const allKeywordsFound = keywords.every(keyword => 
        combinedText.includes(keyword)
      );
      
      // בדיקה אם מדובר בתשובה חיובית (אם יש תנאים מסוימים)
      const isPositiveResponse = 
        answer.toLowerCase().includes('כן') || 
        !answer.toLowerCase().includes('לא') || 
        answer.toLowerCase().includes('חיובי');
      
      if (allKeywordsFound && isPositiveResponse) {
        return true;
      }
    }
    
    return false;
  },
  
  /**
   * יצירת גיליון המלצות מותאם אישית למטופל
   * @param {string} complaint - התלונה העיקרית
   * @param {object} patientRecord - רשומת המטופל
   * @returns {string} - פסקת המלצות בפורמט טקסט
   */
  generateRecommendationsText: function(complaint, patientRecord) {
    const recs = this.getRecommendations(complaint, patientRecord);
    
    let text = "המלצות לטיפול:\n";
    
    // המלצות כלליות
    text += "- " + recs.general.join("\n- ") + "\n";
    
    // המלצות ספציפיות אם יש
    if (recs.specific.length > 0) {
      text += "\nהמלצות מותאמות למצב:";
      recs.specific.forEach(specificRec => {
        text += `\n- ${specificRec.condition}: ${specificRec.recommendations.join(", ")}`;
      });
    }
    
    // אזהרות מיוחדות וסימנים מדאיגים
    if (recs.redFlags && recs.redFlags.length > 0) {
      text += "\n\nדגשים חשובים:";
      recs.redFlags.forEach(flag => {
        text += `\n- ${flag}`;
      });
    }
    
    return text;
  },
  
  /**
   * בודק אם מופיע סימפטום מסוים בתלונת המטופל
   * @param {object} patientRecord - רשומת המטופל 
   * @param {string} symptom - הסימפטום לחיפוש
   * @returns {boolean} - האם הסימפטום מופיע בתלונה
   */
  hasSymptom: function(patientRecord, symptom) {
    if (!patientRecord) return false;
    
    // חיפוש בתלונה העיקרית
    if (patientRecord.patientInfo && 
        patientRecord.patientInfo.mainComplaint &&
        patientRecord.patientInfo.mainComplaint.toLowerCase().includes(symptom.toLowerCase())) {
      return true;
    }
    
    // חיפוש בתשובות המטופל
    const allAnswers = { 
      ...patientRecord.standardAnswers, 
      ...patientRecord.dynamicAnswers 
    };
    
    for (const [question, answer] of Object.entries(allAnswers)) {
      if (!answer || typeof answer !== 'string') continue;
      
      // בדיקה אם השאלה או התשובה מכילות את הסימפטום
      // וגם שהתשובה חיובית
      if ((question.toLowerCase().includes(symptom.toLowerCase()) || 
           answer.toLowerCase().includes(symptom.toLowerCase())) &&
          (answer.toLowerCase().includes('כן') || 
           !answer.toLowerCase().includes('לא') ||
           answer.toLowerCase().includes('חיובי'))) {
        return true;
      }
    }
    
    return false;
  },
  
  /**
   * בדיקת דגלים אדומים ספציפיים לפי סוג תלונה
   * @param {string} complaint - סוג התלונה
   * @param {object} patientRecord - רשומת המטופל
   * @returns {Array} - רשימת דגלים אדומים רלוונטיים
   */
  checkSpecificRedFlags: function(complaint, patientRecord) {
    // רשימת דגלים אדומים שנמצאו
    const relevantFlags = [];
    
    // בחירת בדיקות רלוונטיות לפי סוג התלונה
    switch (complaint.toLowerCase()) {
      case "כאב ראש":
        if (this.hasSymptom(patientRecord, "הקאות")) {
          relevantFlags.push("כאב ראש עם הקאות - יש לשקול הערכה רפואית");
        }
        if (this.hasSymptom(patientRecord, "חום גבוה")) {
          relevantFlags.push("כאב ראש עם חום גבוה - יש לשקול זיהום");
        }
        if (this.hasSymptom(patientRecord, "רגישות לאור")) {
          relevantFlags.push("כאב ראש עם רגישות לאור - סימן אפשרי למיגרנה או דלקת קרום המוח");
        }
        break;
        
      case "כאב חזה":
        if (this.hasSymptom(patientRecord, "קוצר נשימה")) {
          relevantFlags.push("כאב חזה עם קוצר נשימה - דורש הערכה רפואית דחופה");
        }
        if (this.hasSymptom(patientRecord, "הזעה")) {
          relevantFlags.push("כאב חזה עם הזעה - חשד לבעיה לבבית");
        }
        if (this.hasSymptom(patientRecord, "הקרנה")) {
          relevantFlags.push("כאב חזה מקרין לזרוע או ללסת - חשד לבעיה לבבית");
        }
        break;
        
      case "כאב בטן":
        if (this.hasSymptom(patientRecord, "דם")) {
          relevantFlags.push("דם בצואה או בהקאות - מצריך הערכה דחופה");
        }
        if (this.hasSymptom(patientRecord, "חום")) {
          relevantFlags.push("כאב בטן עם חום - חשד לזיהום");
        }
        break;
        
      // אפשר להוסיף עוד מקרים לפי הצורך
    }
    
    return relevantFlags;
  }
};

// ייצוא המודול
if (typeof module !== 'undefined' && module.exports) {
  module.exports = MedicalGuide;
} else if (typeof window !== 'undefined') {
  // אם אנחנו בסביבת דפדפן, הוסף למרחב השמות הגלובלי
  window.MedicalGuide = MedicalGuide;
}