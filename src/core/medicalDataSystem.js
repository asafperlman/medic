// src/core/medicalDataSystem.js

/**
 * מערכת איסוף נתונים רפואיים
 * מודול זה מכיל את הפונקציות העיקריות לניהול רשומות מטופלים,
 * איסוף נתונים, ויצירת סיכומים
 */

// נתחיל בהגדרת המבנה הבסיסי של המערכת
const MedicalDataSystem = {
  // מאגר תלונות נפוצות
  commonComplaints: [
    "כאב גרון",
    "כאב ראש",
    "כאב בטן",
    "כאב גב",
    "שיעול",
    "קוצר נשימה",
    "סחרחורת",
    "בחילה",
    "הקאות",
    "פריחה בעור",
    "חום",
    "חולשה כללית",
    "כאב אוזניים",
    "כאב חזה",
    // פציעות נוספות
    "שבר", 
    "נקע",
    "פציעת ספורט",
    "חתך", 
    "שריטה",
    "כוויה",
    "תאונת דרכים",
    "נפילה מגובה",
    "פציעת ראש",
    "דימום",
    "חבלה",
    "מכה",
    "עקיצה",
    "הכשת נחש",
    "הכשת עקרב",
    "הרעלה",
    "התייבשות",
    "היפותרמיה",
    "היפרתרמיה",
    "טביעה",
    "התקף חרדה",
    "התקף אפילפסיה",
    "פגיעה בעין",
    "גוף זר בעין",
    "פגיעה בשן",
    "דלקת עיניים",
    "דלקת אוזניים",
    "אחר"
  ],

  // מאגר שאלות סטנדרטיות לפי תלונה עיקרית - שאלות מפורטות יותר
  standardQuestions: {
    "כאב גרון": [
      "כמה זמן נמשך הכאב בגרון?",
      "האם יש חום? אם כן, מה גובהו ומתי נמדד לאחרונה?",
      "האם יש קושי בבליעה? באיזו רמה (קל/בינוני/חמור)?",
      "האם יש צרידות או שינוי בקול?",
      "האם יש נזלת או שיעול המלווים את כאב הגרון?",
      "האם יש נפיחות בצוואר או בבלוטות הלימפה?",
      "האם יש נקודות לבנות או אדומות בגרון?",
      "האם היו אירועים דומים בעבר?",
      "האם היית במגע עם אנשים חולים לאחרונה?"
    ],
    "כאב ראש": [
      "כמה זמן נמשך כאב הראש?",
      "היכן ממוקם הכאב (מצח, רקות, עורף, חד צדדי, דו-צדדי)?",
      "כיצד התחיל הכאב (בהדרגה או בפתאומיות)?",
      "כיצד היית מתאר את אופי הכאב (לוחץ, פועם, דוקר)?",
      "האם יש חום או חולשה כללית?",
      "האם יש רגישות לאור, רעש או ריחות?",
      "האם יש בחילה או הקאות המלוות את הכאב?",
      "האם הכאב מחמיר בפעילות מסוימת (תנועה, שינוי תנוחה)?",
      "האם לקחת משככי כאבים? אם כן, איזה והאם הוקל?"
    ],
    "כאב בטן": [
      "כמה זמן נמשך כאב הבטן?",
      "היכן ממוקם הכאב (באיזה חלק מהבטן)?",
      "האם הכאב קבוע או מתפרץ בהתקפים?",
      "האם הכאב מקרין לאזורים אחרים בגוף?",
      "האם יש שינויים ביציאות (שלשול, עצירות, יציאות דמיות)?",
      "האם יש בחילות, הקאות או חוסר תיאבון?",
      "האם יש חום או צמרמורות?",
      "האם כאב הבטן משתנה לאחר אכילה או יציאה?",
      "האם יש גזים, נפיחות או שיהוקים מרובים?"
    ],
    "כאב גב": [
      "כמה זמן נמשך כאב הגב?",
      "היכן ממוקם הכאב (גב עליון, אמצעי, תחתון)?",
      "האם הכאב התחיל בפתאומיות או בהדרגה?",
      "האם קדמה לכאב חבלה או פעילות מאומצת?",
      "האם הכאב מקרין לרגליים או לאזורים אחרים בגוף?",
      "האם יש תחושות נימול או חולשה ברגליים?",
      "האם הכאב משתנה בתנועה, שכיבה או ישיבה?",
      "האם יש קושי בהליכה או תנועה בשל הכאב?",
      "האם לקחת תרופות לשיכוך כאבים? איזה ובאיזו מידה הן עוזרות?"
    ],
    "שיעול": [
      "כמה זמן נמשך השיעול?",
      "האם השיעול יבש או עם ליחה?",
      "אם יש ליחה, מה צבעה (שקופה, צהובה, ירוקה, דמית)?",
      "האם השיעול חמור יותר בזמנים מסוימים ביום או בתנאים מסוימים?",
      "האם יש קוצר נשימה או צפצופים?",
      "האם יש כאב חזה בזמן השיעול?",
      "האם יש חום או צמרמורות?",
      "האם יש נזלת או כאב גרון המלווים את השיעול?",
      "האם היית חשוף לאנשים עם שיעול או נזלת לאחרונה?"
    ],
    "קוצר נשימה": [
      "מתי התחיל קוצר הנשימה?",
      "האם קוצר הנשימה הופיע בפתאומיות או בהדרגה?",
      "האם זה קורה במנוחה, במאמץ קל או רק במאמץ משמעותי?",
      "האם יש כאב בחזה המלווה את קוצר הנשימה?",
      "האם אתה מרגיש דפיקות לב מהירות או חריגות?",
      "האם יש שיעול או ליחה? אם כן, מה צבעה?",
      "האם יש נפיחות ברגליים?",
      "האם יש לך רקע של מחלות לב או ריאה?",
      "האם אתה מעשן או נחשפת לעשן או זיהום אוויר לאחרונה?"
    ],
    "פציעת ראש": [
      "כיצד אירעה הפציעה בראש?",
      "האם היה אובדן הכרה? אם כן, לכמה זמן?",
      "האם יש כאב ראש? מה עוצמתו ומיקומו?",
      "האם יש בחילה או הקאות?",
      "האם יש סחרחורת או בעיות בשיווי משקל?",
      "האם הרגשת בלבול, חוסר התמצאות או אובדן זיכרון?",
      "האם יש טשטוש ראייה או רגישות לאור?",
      "האם זרם דם או נוזל שקוף מהאף או האוזניים?",
      "האם ישנת מאז הפציעה, ואם כן, האם היה קושי להעיר אותך?"
    ],
    "שבר": [
      "היכן ממוקם השבר החשוד?",
      "כיצד אירעה הפציעה?",
      "האם יש עיוות נראה לעין או שינוי צורה באזור הפגוע?",
      "מה עוצמת הכאב (בסולם 1-10)?",
      "האם יש נפיחות, אודם או שטף דם באזור?",
      "האם יש הגבלה בתנועה באזור הפגיעה?",
      "האם יכול/ה לשאת משקל על האזור הפגוע (אם מדובר בגפה תחתונה)?",
      "האם שמעת קול נקישה או חריקה בזמן הפגיעה?",
      "האם יש שינוי בצבע או בטמפרטורה של האזור הפגוע?"
    ],
    "כוויה": [
      "מה גרם לכוויה (חום יבש, נוזל חם, כימיקלים, חשמל)?",
      "מתי התרחשה הכוויה?",
      "באיזה אזור בגוף הכוויה וכמה שטח מכוסה?",
      "מה עומק הכוויה (אדמומיות בלבד, שלפוחיות, פגיעה עמוקה)?",
      "האם הכוויה פוגעת בפנים, ידיים, רגליים, מפרקים או אברי מין?",
      "האם ננקטו פעולות עזרה ראשונה? אם כן, אילו?",
      "האם יש כאב? מה עוצמתו?",
      "האם יש סימנים של זיהום (מוגלה, ריח רע, נפיחות מתגברת)?",
      "האם חוסנת נגד טטנוס בחמש השנים האחרונות?"
    ],
    "סחרחורת": [
      "מתי התחילה הסחרחורת?",
      "האם יש תחושה שהחדר מסתובב או שאתה מסתובב?",
      "האם הסחרחורת מופיעה בשינוי תנוחה או מתרחשת כל הזמן?",
      "האם יש בחילה או הקאות יחד עם הסחרחורת?",
      "האם יש טשטוש ראייה או כפל ראייה?",
      "האם יש רעשים או צלצולים באוזניים?",
      "האם יש חולשה, נימול או קושי בדיבור?",
      "האם איבדת שיווי משקל או נפלת בגלל הסחרחורת?",
      "האם יש לך רקע של בעיות אוזניים, מיגרנות או לחץ דם גבוה?"
    ],
    "חום": [
      "מה גובה החום שנמדד ומתי נמדד לאחרונה?",
      "כמה זמן נמשך החום?",
      "האם החום קבוע או עולה ויורד לאורך היום?",
      "האם יש תסמינים נוספים (שיעול, כאב גרון, כאב בטן, כאבי שרירים)?",
      "האם יש צמרמורות או הזעה מוגברת?",
      "האם יש פריחה בעור או רגישות לאור?",
      "האם נטלת תרופות להורדת חום? אם כן, איזה ומה ההשפעה?",
      "האם היית במגע עם אנשים חולים לאחרונה?",
      "האם יש לך מחלות רקע או מערכת חיסון מוחלשת?"
    ],
    // תבנית שאלות כללית משופרת לכל סוגי הפציעות/מחלות שלא הוגדרו ספציפית
    "אחר": [
      "מתי התחילו הסימפטומים בדיוק (תאריך ושעה אם זכור)?",
      "האם הסימפטומים הופיעו בפתאומיות או התפתחו בהדרגה?",
      "מה עוצמת הסימפטומים בסולם של 1-10?",
      "האם הסימפטומים משתנים במהלך היום או קבועים?",
      "האם יש גורמים מסוימים שמחמירים את המצב (תנועה, אוכל, מאמץ)?",
      "האם יש גורמים שמקלים על הסימפטומים?",
      "האם יש סימפטומים נוספים מלבד התלונה העיקרית?",
      "האם ניסית טיפול כלשהו עד כה? אם כן, מה והאם זה עזר?",
      "האם יש רקע רפואי שיכול להיות קשור למצב הנוכחי?"
    ]
  },

  // פונקציה ליצירת רשומת מטופל חדשה - מעודכנת עם שדות פרופיל
  createPatientRecord: function(age, gender, mainComplaint, profile, medicalSections, allergies, medications) {
    return {
      patientInfo: {
        age: age,
        gender: gender,
        mainComplaint: mainComplaint,
        timestamp: new Date().toISOString(),
        // שדות פרופיל חדשים
        profile: profile || "97",
        medicalSections: medicalSections || "ללא סעיפים",
        allergies: allergies || "ללא אלרגיות ידועות",
        medications: medications || "לא נוטל תרופות באופן קבוע"
      },
      standardAnswers: {},
      dynamicAnswers: {},
      summary: ""
    };
  },

  // פונקציה לקבלת שאלות סטנדרטיות לפי תלונה
  getStandardQuestions: function(complaint) {
    // אם יש שאלות מוגדרות לתלונה, החזר אותן
    if (this.standardQuestions[complaint]) {
      return this.standardQuestions[complaint];
    }
    
    // אחרת החזר שאלות כלליות
    return this.standardQuestions["אחר"] || [
      "מתי התחילו הסימפטומים בדיוק (תאריך ושעה אם זכור)?",
      "האם הסימפטומים הופיעו בפתאומיות או התפתחו בהדרגה?",
      "מה עוצמת הסימפטומים בסולם של 1-10?",
      "האם הסימפטומים משתנים במהלך היום או קבועים?",
      "האם יש גורמים מסוימים שמחמירים את המצב (תנועה, אוכל, מאמץ)?",
      "האם יש גורמים שמקלים על הסימפטומים?",
      "האם יש סימפטומים נוספים מלבד התלונה העיקרית?",
      "האם ניסית טיפול כלשהו עד כה? אם כן, מה והאם זה עזר?",
      "האם יש רקע רפואי שיכול להיות קשור למצב הנוכחי?"
    ];
  },

  // פונקציה לשמירת תשובות לשאלות סטנדרטיות
  saveStandardAnswers: function(patientRecord, answers) {
    patientRecord.standardAnswers = answers;
    return patientRecord;
  },

  // פונקציה להשגת שאלות דינמיות על בסיס התשובות הקודמות
  getDynamicQuestions: function(complaint, previousAnswers) {
    // ניתוח התשובות הקודמות לזיהוי סימפטומים ייחודיים
    let hasSymptom = (keyword) => {
      return Object.values(previousAnswers).some(answer => 
        answer.toLowerCase().includes(keyword.toLowerCase()) &&
        answer.toLowerCase().includes('כן'));
    };
    
    // מיפוי שאלות המשך מותאמות לפי סוג התלונה ותשובות קודמות
    const dynamicQuestionsMap = {
      "כאב ראש": [
        "האם יש הפרעות ראייה כמו טשטוש או כפל ראייה?",
        "האם הכאב מתגבר בשכיבה או התכופפות?",
        "האם יש תחושה של לחץ מאחורי העיניים?",
        "האם זהו כאב ראש חזק יותר מכאבים קודמים?",
        hasSymptom('הקאות') ? "האם ההקאות התגברו בשעות האחרונות?" : "האם יש רגישות יתר לריחות במהלך הכאב?",
        hasSymptom('אור') ? "האם הרגישות לאור מופיעה רק בזמן הכאב או גם לפני?" : "האם יש רגישות לאור או רעש?",
        hasSymptom('דופק') ? "האם אתה חש דופק בראש יחד עם הכאב?" : "האם יש תחושת דפיקות בראש?",
        "האם יש תסמינים שמופיעים לפני התחלת הכאב (אאורה)?",
        "האם הכאב החל אחרי פעילות פיזית מאומצת או שינוי בתרופות?"
      ],
      "כאב בטן": [
        "האם אכלת משהו חדש או חריג לאחרונה?",
        "האם יש תחושת ׳מלאות׳ או כבדות בבטן?",
        "האם הכאב מפריע לשינה?",
        hasSymptom('שלשול') ? "כמה יציאות יש ביום וכיצד הן נראות?" : "האם יש שינוי בתדירות או בצורת היציאות?",
        hasSymptom('דם') ? "האם ראית דם ביציאות או בהקאות?" : "האם הבחנת בדם ביציאות או שהיציאות כהות באופן חריג?",
        hasSymptom('הקאות') ? "האם ההקאות מכילות מזון שאכלת לאחרונה או נוזל אחר?" : "האם יש בחילות או הקאות?",
        hasSymptom('חום') ? "מה גובה החום וכמה זמן הוא נמשך?" : "האם יש חום או צמרמורות?",
        "האם הכאב מקרין לגב, לכתף או למקומות אחרים?",
        "האם יש תחושת בטן נפוחה או גזים מרובים?"
      ],
      "כאב גרון": [
        "האם אתה מרגיש גוש או נפיחות בגרון?",
        "האם הקושי בבליעה מתייחס לנוזלים, מוצקים או שניהם?",
        "האם יש שינוי בטעם או ריח?",
        hasSymptom('חום') ? "האם החום נמשך יותר מ-3 ימים?" : "האם יש תחושת חמימות או חום?",
        hasSymptom('נקודות') ? "האם הנקודות הלבנות בגרון גדלות או משתנות?" : "האם הבחנת בנקודות לבנות או כתמים בגרון?",
        hasSymptom('בלוטות') ? "האם הבלוטות הנפוחות רגישות למגע?" : "האם יש נפיחות בבלוטות הצוואר?",
        hasSymptom('קשיי נשימה') ? "האם קשיי הנשימה גוברים בשכיבה?" : "האם יש קושי בנשימה או שריקות בעת נשימה?",
        "האם כאב הגרון הוא בצד אחד או בשני הצדדים?",
        "האם הדיבור כואב או משתנה (צרידות, קושי בדיבור)?"
      ],
      "פציעת ראש": [
        "האם אתה זוכר את האירוע שגרם לפציעה בבירור?",
        "האם יש אזורים רכים או נפוחים בראש?",
        "האם יש שינויים בהתנהגות או במצב הרוח מאז הפגיעה?",
        hasSymptom('הכרה') ? "למשך כמה זמן הייתה אובדן ההכרה?" : "האם היו אירועים של בלבול או חוסר זיכרון?",
        hasSymptom('הקאות') ? "האם ההקאות חוזרות או הן היו חד פעמיות?" : "האם יש בחילות או הקאות?",
        hasSymptom('ראייה') ? "האם שינויי הראייה משתפרים או מחמירים?" : "האם יש שינויים בראייה או רגישות לאור?",
        hasSymptom('סחרחורת') ? "האם הסחרחורת משתנה בתנוחות שונות או קבועה?" : "האם יש סחרחורת או בעיות בשיווי משקל?",
        "האם יש רעשים או צלצולים באוזניים מאז הפגיעה?",
        "האם הצלחת להירדם לאחר הפגיעה ואם כן, האם היה קושי להתעורר?"
      ],
      "שבר": [
        "האם יש בשבר החשוד חדירה של העצם דרך העור?",
        "האם יכול/ה להזיז את האצבעות/כף הרגל מתחת לאזור הפגוע?",
        "האם יש סימנים של פגיעה בכלי דם (חיוורון, קור, דופק חלש)?",
        hasSymptom('נפיחות') ? "האם הנפיחות גוברת או יציבה?" : "האם יש נפיחות באזור?",
        hasSymptom('דפורמציה') ? "האם העיוות באזור השבר בולט או מוסתר?" : "האם יש עיוות נראה לעין באזור?",
        hasSymptom('תנועה') ? "האם התנועה באזור הפגוע גורמת לכאב חד?" : "האם יש הגבלה בתנועה?",
        hasSymptom('כאב') ? "האם הכאב משתנה או קבוע בעוצמתו?" : "מה עוצמת הכאב בסולם 1-10?",
        "האם ניסית לקבע את האזור הפגוע? אם כן, כיצד?",
        "האם יש תחושת נימול או חוסר תחושה מתחת לאזור הפגיעה?"
      ]
    };
    
    // אם יש שאלות ספציפיות לתלונה
    if (dynamicQuestionsMap[complaint]) {
      return dynamicQuestionsMap[complaint];
    }
    
    // שאלות המשך כלליות משופרות
    return [
      "האם יש שינויים ברמת האנרגיה או העייפות שלך לאחרונה?",
      "האם יש שינויים בהרגלי האכילה או השתייה שלך?",
      "האם יש שינויים בהרגלי השינה שלך לאחרונה?",
      "האם חווית מצבים דומים בעבר? אם כן, כיצד טופלו?",
      "האם יש גורמים סביבתיים שעשויים להשפיע על מצבך (חשיפה לחומרים, אלרגנים)?",
      "האם חל שינוי במשקל שלך לאחרונה ללא סיבה ברורה?",
      "האם יש לך מחלות כרוניות שיכולות להיות קשורות למצב הנוכחי?",
      "האם היו שינויים בתרופות שאתה נוטל לאחרונה?",
      "האם יש משהו נוסף שחשוב שנדע על מצבך הבריאותי?"
    ];
  },

  // פונקציה לשמירת תשובות לשאלות דינמיות
  saveDynamicAnswers: function(patientRecord, answers) {
    patientRecord.dynamicAnswers = answers;
    return patientRecord;
  },

  // פונקציה ליצירת סיכום אנמנזה משופר
  generateSummary: function(patientRecord) {
    try {
      // חילוץ מידע בסיסי
      const { age, gender, mainComplaint, profile, medicalSections, allergies, medications } = patientRecord.patientInfo;
      const genderText = gender === 'male' ? 'זכר' : 'נקבה';
      
      // פתיחת האנמנזה עם פרטי הפרופיל הרפואי
      let summary = `פרופיל ${profile}, ${medicalSections}, ${allergies}, ${medications}.\n\n`;
      
      // תיאור דמוגרפי ותלונה עיקרית
      summary += `מטופל/ת בגיל ${age}, ${genderText}, מתלונן/ת על ${mainComplaint} `;
      
      // איסוף מידע משמעותי מהתשובות
      let duration = "";
      let painLocation = "";
      let painCharacteristics = [];
      let associatedSymptoms = [];
      let aggravatingFactors = [];
      let relievingFactors = [];
      let treatments = [];
      
      // חיפוש תשובות רלוונטיות מהשאלות הסטנדרטיות והדינמיות
      const allAnswers = {
        ...patientRecord.standardAnswers,
        ...patientRecord.dynamicAnswers
      };
      
      // עיבוד המידע מהתשובות
      for (const [question, answer] of Object.entries(allAnswers)) {
        if (!answer || answer.trim() === '') continue;
        
        // זיהוי קטגוריות מידע שונות
        if (question.includes("זמן") || question.includes("מתי") || question.includes("כמה זמן") || question.includes("משך")) {
          duration = answer;
        } 
        else if (question.includes("היכן") || question.includes("מיקום") || question.includes("איפה") || question.includes("ממוקם")) {
          painLocation = answer;
        }
        else if (question.includes("אופי") || question.includes("מתאר") || question.includes("סוג")) {
          painCharacteristics.push(answer);
        }
        else if (question.includes("מחמיר") || question.includes("גורם להחמרה")) {
          aggravatingFactors.push(answer);
        }
        else if (question.includes("מקל") || question.includes("גורם להקלה")) {
          relievingFactors.push(answer);
        }
        else if (question.includes("סימפטומים נוספים") || question.includes("תסמינים") || 
                 question.includes("בחילה") || question.includes("הקאות") || 
                 question.includes("חום") || question.includes("סחרחורת")) {
          associatedSymptoms.push(`${question.replace('?', '')}: ${answer}`);
        }
        else if (question.includes("טיפול") || question.includes("תרופות") || question.includes("לקחת")) {
          treatments.push(`${question.replace('?', '')}: ${answer}`);
        }
      }
      
      // בניית משפט משמעותי על התלונה העיקרית
      if (duration) {
        summary += `המתחיל/ה לפני ${duration}`;
      }
      
      if (painLocation) {
        summary += ` ומתמקם ב${painLocation}`;
      }
      
      if (painCharacteristics.length > 0) {
        summary += `. הכאב מתואר כ${painCharacteristics.join(", ")}`;
      }
      
      summary += '. ';
      
      // הוספת גורמים מחמירים ומקלים
      if (aggravatingFactors.length > 0 || relievingFactors.length > 0) {
        if (aggravatingFactors.length > 0) {
          summary += `גורמים המחמירים את המצב: ${aggravatingFactors.join(", ")}. `;
        }
        
        if (relievingFactors.length > 0) {
          summary += `גורמים המקלים על המצב: ${relievingFactors.join(", ")}. `;
        }
        
        summary += '\n\n';
      }
      
      // הוספת סימפטומים נלווים
      if (associatedSymptoms.length > 0) {
        summary += `סימפטומים נלווים: ${associatedSymptoms.join("; ")}. \n\n`;
      }
      
      // הוספת מידע על טיפולים
      if (treatments.length > 0) {
        summary += `טיפולים שננקטו: ${treatments.join("; ")}. \n\n`;
      }
      
      // בדיקה לדגלים אדומים
      const redFlags = this.checkForRedFlags(patientRecord);
      
      if (redFlags.length > 0) {
        summary += `דגלים אדומים: ${redFlags.join("; ")}.`;
      }
      
      patientRecord.summary = summary;
      return patientRecord;
    } catch (error) {
      console.error("שגיאה ביצירת סיכום:", error);
      
      // אם יש שגיאה, יצירת סיכום בסיסי
      const { age, gender, mainComplaint, profile, medicalSections, allergies, medications } = patientRecord.patientInfo;
      const genderText = gender === 'male' ? 'זכר' : 'נקבה';
      
      patientRecord.summary = `פרופיל ${profile}, ${medicalSections}, ${allergies}, ${medications}.\n\nמטופל/ת בגיל ${age}, ${genderText}, עם תלונה עיקרית של ${mainComplaint}.\n\nלא ניתן היה ליצור סיכום מפורט עקב בעיה טכנית.`;
      
      return patientRecord;
    }
  },

  // פונקציית בדיקת דגלים אדומים משופרת
  checkForRedFlags: function(patientRecord) {
    const redFlags = [];
    const { mainComplaint } = patientRecord.patientInfo;
    const allAnswers = { ...patientRecord.standardAnswers, ...patientRecord.dynamicAnswers };
    
    // פונקציית עזר משופרת לבדיקת תשובות
    const containsKeyword = (keywords, positiveTerms = ['כן', 'חיובי', 'נכון']) => {
      if (!Array.isArray(keywords)) keywords = [keywords];
      
      for (const [question, answer] of Object.entries(allAnswers)) {
        if (!answer) continue;
        
        // בדיקה אם השאלה או התשובה מכילות את אחת ממילות המפתח
        const questionOrAnswerContainsKeyword = keywords.some(keyword => 
          question.toLowerCase().includes(keyword.toLowerCase()) || 
          answer.toLowerCase().includes(keyword.toLowerCase())
        );
        
        // בדיקה אם התשובה חיובית
        const isPositiveResponse = positiveTerms.some(term => 
          answer.toLowerCase().includes(term.toLowerCase())
        ) || !['לא', 'שלילי', 'אין'].some(term => 
          answer.toLowerCase().includes(term.toLowerCase())
        );
        
        if (questionOrAnswerContainsKeyword && isPositiveResponse) {
          return true;
        }
      }
      return false;
    };
    
    // בדיקות ספציפיות לתלונות שונות לפי מדריך הטיפול הרפואי
    
    // כאב ראש - דגלים אדומים
    if (mainComplaint.includes("כאב ראש")) {
      if (containsKeyword(["הופעה פתאומית", "פתאומי", "חד"])) 
        redFlags.push("כאב ראש שהופיע בפתאומיות - יש לשקול הערכה נוירולוגית");
      
      if (containsKeyword(["הקאות", "בחילות"]) && containsKeyword(["מרובות", "חוזרות"]))
        redFlags.push("הקאות בשילוב עם כאב ראש");
      
      if (containsKeyword(["חמור", "חזק ביותר", "הכי גרוע"]))
        redFlags.push("כאב ראש בעוצמה גבוהה מאוד");
      
      if (containsKeyword(["הפרעות ראייה", "טשטוש", "כפל ראייה"]))
        redFlags.push("הפרעות ראייה המלוות כאב ראש");
      
      if (containsKeyword(["נימול", "חולשה בגפיים"]))
        redFlags.push("תסמינים נוירולוגיים המלווים כאב ראש");
      
      if (containsKeyword(["מעיר משינה", "מתעורר בגלל הכאב"]))
        redFlags.push("כאב ראש המעיר משינה");
    }
    
    // כאב חזה - דגלים אדומים
    else if (mainComplaint.includes("כאב חזה")) {
      if (containsKeyword(["קוצר נשימה", "קשיי נשימה"]))
        redFlags.push("כאב חזה בשילוב עם קוצר נשימה - יש לשלול מצב לבבי או ריאתי חריף");
      
      if (containsKeyword(["זיעה", "הזעה", "זיעה קרה"]))
        redFlags.push("כאב חזה בשילוב עם הזעה");
      
      if (containsKeyword(["לחץ", "מועקה", "כבדות"]))
        redFlags.push("תחושת לחץ או מועקה בחזה");
      
      if (containsKeyword(["הקרנה", "מקרין", "פשט", "התפשט"], ["ליד", "לזרוע", "לכתף", "ללסת"]))
        redFlags.push("כאב חזה המקרין לזרוע, כתף או לסת");
      
      if (containsKeyword(["בחילה", "סחרחורת"]) && containsKeyword(["חזה"]))
        redFlags.push("כאב חזה המלווה בבחילה או סחרחורת");
    }
    
    // פציעת ראש - דגלים אדומים
    else if (mainComplaint.includes("פציעת ראש")) {
      if (containsKeyword(["איבוד הכרה", "התעלפות", "איבד הכרה"]))
        redFlags.push("איבוד הכרה לאחר פציעת ראש");
      
      if (containsKeyword(["הקאות", "בחילות"]) && containsKeyword(["חוזרות", "מרובות"]))
        redFlags.push("הקאות חוזרות לאחר פציעת ראש");
      
      if (containsKeyword(["בלבול", "חוסר התמצאות", "חוסר זיכרון"]))
        redFlags.push("בלבול או חוסר התמצאות לאחר פציעת ראש");
      
      if (containsKeyword(["נוזל", "דימום"]) && containsKeyword(["אוזניים", "אף", "פה"]))
        redFlags.push("נוזל או דימום מהאוזניים או האף");
      
      if (containsKeyword(["אישונים לא שווים", "תגובת אישונים"]))
        redFlags.push("אישונים לא שווים או תגובה לא תקינה לאור");
      
      if (containsKeyword(["קושי להעיר", "שינה עמוקה"]))
        redFlags.push("קושי להעיר את המטופל לאחר פציעת ראש");
    }
    
    // כאב בטן - דגלים אדומים
    else if (mainComplaint.includes("כאב בטן")) {
      if (containsKeyword(["דם", "דמי"]) && (containsKeyword(["צואה", "יציאות"]) || containsKeyword(["הקאה", "הקאות"])))
        redFlags.push("דם בצואה או בהקאות");
      
      if (containsKeyword(["כאב חזק", "כאב חמור"]) && containsKeyword(["ימין תחתונה", "צד ימין למטה"]))
        redFlags.push("כאב חזק בבטן ימין תחתונה - יש לשלול אפנדיציט");
      
      if (containsKeyword(["קושי במתן שתן", "כאב במתן שתן"]) && containsKeyword(["בטן"]))
        redFlags.push("כאב בטן המלווה בבעיות במתן שתן");
      
      if (containsKeyword(["בטן קשה", "בטן מתוחה", "נוקשות"]))
        redFlags.push("בטן קשה או מתוחה - יש לשלול מצב כירורגי חריף");
      
      if (containsKeyword(["חום"]) && containsKeyword(["בטן"]))
        redFlags.push("כאב בטן המלווה בחום - יש לשלול זיהום חמור");
    }
    
    // שבר - דגלים אדומים
    else if (mainComplaint.includes("שבר")) {
      if (containsKeyword(["עצם חודרת", "עצם בולטת", "חדירה של העצם"]))
        redFlags.push("שבר פתוח - עצם חודרת דרך העור");
      
      if (containsKeyword(["חוסר תחושה", "נימול", "חוסר יכולת להזיז"]))
        redFlags.push("סימני פגיעה עצבית באזור השבר");
      
      if (containsKeyword(["דופק חלש", "חיוורון", "קור"]) && !containsKeyword(["חזר", "השתפר"]))
        redFlags.push("סימני פגיעה בכלי דם מתחת לאזור השבר");
      
      if (containsKeyword(["צוואר", "גב", "ראש", "אגן", "ירך"]))
        redFlags.push("שבר באזור קריטי - מצריך טיפול מיידי");
    }
    
    // קוצר נשימה - דגלים אדומים
    else if (mainComplaint.includes("קוצר נשימה")) {
      if (containsKeyword(["במנוחה", "ללא מאמץ"]))
        redFlags.push("קוצר נשימה במנוחה - מצריך הערכה דחופה");
      
      if (containsKeyword(["כחלון", "שפתיים כחולות"]))
        redFlags.push("כחלון - סימן לחמצון נמוך");
      
      if (containsKeyword(["דיבור קטוע", "לא מסוגל לדבר משפט"]))
        redFlags.push("קוצר נשימה המקשה על הדיבור");
      
      if (containsKeyword(["דפיקות לב", "דופק מהיר"]))
        redFlags.push("קוצר נשימה המלווה בדפיקות לב");
    }
    
    // כוויה - דגלים אדומים
    else if (mainComplaint.includes("כוויה")) {
      if (containsKeyword(["פנים", "עיניים", "אוזניים"]))
        redFlags.push("כוויה באזור הפנים או העיניים");
      
      if (containsKeyword(["נשימה", "קוצר", "שאיפה"]))
        redFlags.push("כוויה במערכת הנשימה או קוצר נשימה");
      
      if (containsKeyword(["גדולה", "נרחבת", "מעל 10%"]))
        redFlags.push("כוויה נרחבת - מעל 10% משטח הגוף");
      
      if (containsKeyword(["עמוקה", "דרגה 3", "לבנה", "שחורה"]))
        redFlags.push("כוויה עמוקה (דרגה 3)");
      
      if (containsKeyword(["חשמל", "מתח"]))
        redFlags.push("כוויה כתוצאה מחשמל - סיכון לפגיעה פנימית");
    }
    
    // דגלים אדומים כלליים
    if (containsKeyword(["קשיי נשימה", "קוצר נשימה חמור"]))
      redFlags.push("קשיי נשימה משמעותיים");
    
    if (containsKeyword(["הקאות", "דם"]) && !containsKeyword(["שלילי", "אין"]))
      redFlags.push("הקאות דמיות");
    
    if (containsKeyword(["חום גבוה", "חום מעל 39"]))
      redFlags.push("חום גבוה מעל 39 מעלות");
    
    if (containsKeyword(["בלבול", "חוסר התמצאות", "הזיות"]))
      redFlags.push("שינוי במצב ההכרה או בלבול");
    
    if (containsKeyword(["אובדן הכרה", "התעלפות"]))
      redFlags.push("אובדן הכרה");
    
    return redFlags;
  },

  // פונקציה לשליחת הסיכום לרופא/ה
  sendSummaryToDoctor: async function(patientRecord, doctorEmail) {
    // מדמה שליחת דוא"ל או שמירה במסד נתונים
    return new Promise((resolve) => {
      // מדמה זמן תגובה מהשרת
      setTimeout(() => {
        resolve({
          success: true,
          timestamp: new Date().toISOString(),
          message: `הסיכום נשלח בהצלחה לרופא/ה ${doctorEmail || "המטפל/ת"}`
        });
      }, 1000); // שנייה אחת לדמות זמן תגובה
    });
  }
};

module.exports = MedicalDataSystem;