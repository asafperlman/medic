const express = require('express');
const router = express.Router();
const LLMService = require('../src/api/llmService'); // שים לב שהנתיב צריך להתאים למיקום האמיתי של llmService.js

// API להפקת שאלות דינמיות בעזרת ChatGPT
router.post('/', async (req, res) => {
    try {
        const { complaint, previousAnswers } = req.body;
        
        // בניית פרומפט מתאים לשליחה ל-LLM
        const prompt = buildQuestionsPrompt(complaint, previousAnswers);

        // שולחים את הפרומפט ל-ChatGPT באמצעות LLMService
        const responseText = await LLMService.sendPrompt(prompt);

        // פיצול התשובה לשאלות נפרדות
        const questionLines = responseText.split('\n').map(l => l.trim()).filter(Boolean);

        // יצירת מערך שאלות בפורמט המתאים ל-Frontend
        const dynamicQuestions = questionLines.map(line => ({
            type: 'multiline',  // אפשר להוסיף תנאים כדי לסווג לפי סוגים שונים
            question: line
        }));

        res.json({ success: true, questions: dynamicQuestions });
    } catch (error) {
        console.error('שגיאה ביצירת שאלות דינמיות:', error);
        res.status(500).json({ success: false, error: error.message });
    }
});

// פונקציה לבניית פרומפט
function buildQuestionsPrompt(complaint, previousAnswers) {
    return `
        תלונה ראשית: ${complaint}
        תשובות קודמות של המטופל: ${JSON.stringify(previousAnswers, null, 2)}

        אנא צור 3-5 שאלות המשך רלוונטיות בעברית, המתאימות למצבי רפואה דחופה, ללא מספור, שורה לכל שאלה.
    `.trim();
}

module.exports = router;
