<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת איסוף נתונים רפואיים</title>
    
    <!-- ספריות CSS חיצוניות -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    
    <!-- סגנונות מוטמעים במקום קבצים חיצוניים שלא נטענים -->
    <style>
        /* סגנונות בסיסיים */
        :root {
            --primary-color: #0056b3;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
            transition: var(--transition);
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 30px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* כותרות */
        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 28px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        h2 {
            font-size: 22px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* סרגל התקדמות */
        .progress-bar-container {
            margin: 20px 0;
            padding: 10px 0;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            height: 4px;
            width: 100%;
            background-color: var(--secondary-color);
            transform: translateY(-50%);
            z-index: 1;
        }

        .progress-step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--light-color);
            border: 2px solid var(--secondary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            z-index: 2;
            transition: var(--transition);
        }

        .progress-step.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .progress-step.completed {
            background-color: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }

        /* טפסים */
        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .radio-option input {
            margin-left: 8px;
            width: auto;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #4d94ff;
            box-shadow: 0 0 0 3px rgba(77, 148, 255, 0.2);
            outline: none;
        }

        /* כפתורים */
        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin: 20px 0;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #next-to-step2, #next-to-step3, #next-to-step4, #send-summary, #start-new, .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        #next-to-step2:hover, #next-to-step3:hover, #next-to-step4:hover, #send-summary:hover, #start-new:hover, .btn-primary:hover {
            background-color: #004494;
        }

        .btn-secondary, #back-to-step1, #back-to-step2, #back-to-step3 {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            color: #333;
        }

        .btn-secondary:hover, #back-to-step1:hover, #back-to-step2:hover, #back-to-step3:hover {
            background-color: #e9ecef;
        }

        .btn-success, #complete-summary {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover, #complete-summary:hover {
            background-color: #218838;
        }

        /* רשימת שאלות */
        .questions-list {
            list-style: none;
            padding: 0;
        }

        .question-item {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .question-header {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .answer-container {
            margin-top: 10px;
        }

        /* כפתורי בחירה */
        .gender-selector {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .gender-option {
            flex: 1;
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .gender-option:hover {
            background-color: #e9ecef;
        }

        .gender-option.selected {
            background-color: #e8f4ff;
            border-color: var(--primary-color);
        }

        .gender-option i {
            font-size: 32px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        /* כרטיסי פרופיל */
        .profile-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .profile-card {
            flex: 1;
            min-width: calc(25% - 15px);
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #ced4da;
        }

        .profile-card.selected {
            background-color: #e8f4ff;
            border-color: var(--primary-color);
        }

        .profile-icon {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .profile-desc {
            font-size: 14px;
            color: #6c757d;
        }

        /* סגנון תצוגת סיכום */
        .summary-box {
            background-color: #f0f7ff;
            border: 1px solid #d0e3ff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        /* הודעות טוסט */
        .toast-notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            min-width: 250px;
            max-width: 350px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            display: flex;
            align-items: center;
        }

        .toast-notification.success {
            background-color: #28a745;
        }

        .toast-notification.error {
            background-color: #dc3545;
        }

        .toast-notification.warning {
            background-color: #ffc107;
            color: #333;
        }

        .toast-notification.info {
            background-color: #17a2b8;
        }

        /* טעינה */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* תמיכה במכשירים ניידים */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            .profile-cards {
                flex-direction: column;
            }

            .gender-selector {
                flex-direction: column;
            }
        }

        /* אנימציות */
        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* מצב חשוך */
        [data-theme="dark"] {
            --primary-color: #4d94ff;
            --secondary-color: #adb5bd;
            --light-color: #2c3034;
            --dark-color: #f8f9fa;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            background-color: #1a1d20;
            color: #e9ecef;
        }

        [data-theme="dark"] .container {
            background-color: #2c3034;
            color: #e9ecef;
        }

        [data-theme="dark"] input, 
        [data-theme="dark"] select, 
        [data-theme="dark"] textarea {
            background-color: #1a1d20;
            border-color: #495057;
            color: #e9ecef;
        }

        [data-theme="dark"] .profile-card,
        [data-theme="dark"] .gender-option {
            background-color: #343a40;
            border-color: #495057;
            color: #e9ecef;
        }

        [data-theme="dark"] .question-item {
            background-color: #343a40;
            border-color: #495057;
        }

        /* מצב כהה - מתג */
        .dark-mode-toggle.floating {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        /* API Status Indicator */
        .api-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 20px;
            background-color: #f0f0f0;
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
          
        .api-status-indicator i {
            font-size: 16px;
        }
          
        .api-active {
            background-color: #d4edda;
            color: #155724;
        }
          
        .api-inactive {
            background-color: #fff3cd;
            color: #856404;
        }
          
        .api-offline {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* סגנונות נוספים לשלב סיום */
        .completion-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .completion-icon {
            font-size: 60px;
            color: var(--success-color);
            margin-bottom: 15px;
        }

        .final-summary {
            background-color: white;
            border: 1px solid #e0e0e0;
        }

        .summary-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .copy-button, .print-button, .export-button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            background-color: white;
            border: 1px solid #d0e3ff;
            color: var(--primary-color);
        }

        .completion-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
    </style>
    
    <!-- ספריות JavaScript חיצוניות -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js" defer></script>
</head>
<body>
    <div class="container animate__animated animate__fadeIn">
        <header>
            <h1>מערכת איסוף נתונים רפואיים</h1>
            <p>מערכת לאיסוף מידע רפואי מהמטופל והעברתו לרופא/ה</p>
            <!-- כפתור מצב תצוגה יתווסף כאן דינמית -->
        </header>

        <!-- סרגל התקדמות יתווסף כאן דינמית -->
        <div id="progress-bar-container" class="progress-bar-container"></div>

        <!-- שלב 1: הזנת מידע בסיסי -->
        <div id="step1" class="step active animate__animated animate__fadeIn">
            <h2>שלב 1: מידע בסיסי על המטופל</h2>
            <!-- מידע פרופיל רפואי -->
            <div class="form-group">
                <label>פרופיל רפואי:</label>
                <div class="profile-cards">
                    <div class="profile-card" data-value="97">
                        <div class="profile-icon">97</div>
                        <div class="profile-desc">בריא לחלוטין</div>
                    </div>
                    <div class="profile-card" data-value="82">
                        <div class="profile-icon">82</div>
                        <div class="profile-desc">בריא ברובו</div>
                    </div>
                    <div class="profile-card" data-value="64">
                        <div class="profile-icon">64</div>
                        <div class="profile-desc">מחלה כרונית קלה</div>
                    </div>
                    <div class="profile-card" data-value="21">
                        <div class="profile-icon">21</div>
                        <div class="profile-desc">מחלה כרונית משמעותית</div>
                    </div>
                    <input type="hidden" name="profile" id="profile-value" value="97">
                </div>
            </div>
            <!-- סעיפים רפואיים -->
            <div class="form-group">
                <label for="medical-sections">סעיפים רפואיים:</label>
                <input type="text" id="medical-sections" placeholder="הזן סעיפים (אם יש)">
            </div>
            <!-- אלרגיות -->
            <div class="form-group">
                <label>אלרגיות:</label>
                <div class="radio-group modern">
                    <label class="radio-option">
                        <input type="radio" name="allergies" value="no" checked> ללא אלרגיות ידועות
                        <span class="checkmark"></span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="allergies" value="yes"> יש אלרגיות
                        <span class="checkmark"></span>
                    </label>
                </div>
                <div id="allergies-details-container" style="display: none;" class="details-container animate__animated animate__fadeIn">
                    <input type="text" id="allergies-details" placeholder="פרט אלרגיות...">
                </div>
            </div>
            <!-- תרופות קבועות -->
            <div class="form-group">
                <label>נוטל/ת תרופות באופן קבוע:</label>
                <div class="radio-group modern">
                    <label class="radio-option">
                        <input type="radio" name="medications" value="no" checked> לא
                        <span class="checkmark"></span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="medications" value="yes"> כן
                        <span class="checkmark"></span>
                    </label>
                </div>
                <div id="medications-details-container" style="display: none;" class="details-container animate__animated animate__fadeIn">
                    <input type="text" id="medications-details" placeholder="פרט תרופות...">
                </div>
            </div>
            <!-- שדה עישון (חדש) -->
            <div class="form-group">
                <label>האם את/ה מעשן/ת?</label>
                <div class="radio-group modern">
                    <label class="radio-option">
                        <input type="radio" name="smoking" value="no" checked> לא
                        <span class="checkmark"></span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="smoking" value="yes"> כן
                        <span class="checkmark"></span>
                    </label>
                </div>
                <div id="smoking-details-container" style="display: none;" class="details-container animate__animated animate__fadeIn">
                    <input type="text" id="smoking-details" placeholder="כמה סיגריות ביום? כמה שנים?">
                </div>
            </div>
            <!-- מידע דמוגרפי -->
            <div class="form-group">
                <label for="patient-age">גיל:</label>
                <input type="number" id="patient-age" min="0" max="120" required>
                <!-- כפתורי גיל מהירים יתווספו כאן דינמית -->
                <div class="quick-age-buttons">
                    <button type="button" class="age-button">18</button>
                    <button type="button" class="age-button">19</button>
                    <button type="button" class="age-button">20</button>
                    <button type="button" class="age-button">21</button>
                    <button type="button" class="age-button">22</button>
                    <button type="button" class="age-button">23</button>
                    <button type="button" class="age-button">24</button>
                </div>
            </div>
            <div class="form-group">
                <label>מין:</label>
                <div class="gender-selector">
                    <div class="gender-option" data-value="male">
                        <i class="fas fa-male"></i>
                        <span>זכר</span>
                    </div>
                    <div class="gender-option" data-value="female">
                        <i class="fas fa-female"></i>
                        <span>נקבה</span>
                    </div>
                    <input type="hidden" name="gender" id="gender-value" value="male">
                </div>
            </div>
            <div class="form-group">
                <label for="main-complaint">תלונה עיקרית:</label>
                <!-- שדה חיפוש התלונות יתווסף כאן דינמית -->
                <select id="main-complaint" required>
                    <option value="" disabled selected>בחר תלונה עיקרית</option>
                    <option value="כאב ראש">כאב ראש</option>
                    <option value="כאב גרון">כאב גרון</option>
                    <option value="כאב בטן">כאב בטן</option>
                    <option value="כאב גב">כאב גב</option>
                    <option value="שיעול">שיעול</option>
                    <option value="קוצר נשימה">קוצר נשימה</option>
                    <option value="סחרחורת">סחרחורת</option>
                    <option value="חום">חום</option>
                    <option value="פציעת ספורט">פציעת ספורט</option>
                    <option value="אחר">אחר</option>
                </select>
            </div>
            <div class="form-group" id="other-complaint-container" style="display: none;">
                <label for="other-complaint">פרט תלונה אחרת:</label>
                <input type="text" id="other-complaint">
            </div>
            <div class="button-group">
                <div></div> <!-- שומר מקום לכפתור "הקודם" שיופיע בשלבים הבאים -->
                <button id="next-to-step2" class="btn-primary">
                    <i class="fas fa-arrow-left"></i> המשך לשאלות
                </button>
            </div>
        </div>

        <!-- שלב 2: שאלות סטנדרטיות -->
        <div id="step2" class="step">
            <h2>שלב 2: שאלות לפי תלונה</h2>
            <div id="standard-questions-container">
                <ul class="questions-list" id="standard-questions-list">
                    <!-- שאלות יתווספו דינמית ע"י JavaScript -->
                </ul>
            </div>
            
            <!-- אזור מדדים חיוניים (חדש) -->
            <div id="vital-signs-container" class="vital-signs-container">
                <!-- כאן יתווספו שדות המדדים החיוניים דינמית -->
            </div>
            
            <div class="button-group">
                <button id="back-to-step1" class="btn-secondary">
                    <i class="fas fa-arrow-right"></i> חזור
                </button>
                <button id="next-to-step3" class="btn-primary">
                    <i class="fas fa-arrow-left"></i> המשך לשאלות נוספות
                </button>
            </div>
        </div>

        <!-- שלב 3: שאלות דינמיות -->
        <div id="step3" class="step">
            <h2>שלב 3: שאלות נוספות</h2>
            <div class="loading" id="dynamic-questions-loading">
                <div class="loading-spinner"></div>
                <p>מייצר שאלות נוספות...</p>
            </div>
            <div id="dynamic-questions-container">
                <ul class="questions-list" id="dynamic-questions-list">
                    <!-- שאלות יתווספו דינמית ע"י JavaScript -->
                </ul>
            </div>
            <div class="button-group">
                <button id="back-to-step2" class="btn-secondary">
                    <i class="fas fa-arrow-right"></i> חזור
                </button>
                <button id="next-to-step4" class="btn-primary">
                    <i class="fas fa-file-medical-alt"></i> יצירת סיכום
                </button>
            </div>
        </div>

        <!-- שלב 4: סיכום ושליחה (משודרג) -->
        <div id="step4" class="step">
            <h2>שלב 4: סיכום רפואי</h2>
            <div class="loading" id="summary-loading">
                <div class="loading-spinner"></div>
                <p>מייצר סיכום אנמנזה...</p>
            </div>
            
            <div id="summary-container">
                <div class="summary-box">
                    <h3>סיכום אנמנזה רפואית</h3>
                    <div id="summary-text"></div>
                    <!-- כפתור העתקה -->
                    <button id="copy-summary" class="copy-button">
                        <i class="fas fa-copy"></i> העתק סיכום
                    </button>
                </div>
                
                <!-- מידע נוסף -->
                <div class="additional-info-box">
                    <h3>מה הלאה?</h3>
                    <p>הסיכום הרפואי הופק בהצלחה. באפשרותך:</p>
                    <ul>
                        <li>להעתיק את הסיכום לשימוש מיידי</li>
                        <li>לשלוח את הסיכום לרופא/ה באמצעות דוא"ל (אופציונלי)</li>
                        <li>לחזור לשלבים קודמים לעדכון פרטים</li>
                    </ul>
                </div>
                
                <!-- כפתור לסיום בלי צורך בדוא"ל -->
                <div class="form-group">
                    <button id="complete-summary" class="btn-success">
                        <i class="fas fa-check-circle"></i> סיים וחזור להתחלה
                    </button>
                </div>
                
                <!-- אופציונלי - שליחה לרופא -->
                <div class="form-group optional-section">
                    <label for="doctor-email">כתובת דוא"ל של הרופא/ה (אופציונלי):</label>
                    <div class="email-input-group">
                        <i class="fas fa-envelope input-icon"></i>
                        <input type="email" id="doctor-email" placeholder="הזן כתובת דוא"ל...">
                    </div>
                    <button id="send-summary" class="btn-primary">
                        <i class="fas fa-paper-plane"></i> שלח סיכום
                    </button>
                </div>
            </div>
            
            <div class="button-group">
                <button id="back-to-step3" class="btn-secondary">
                    <i class="fas fa-arrow-right"></i> חזור
                </button>
            </div>
        </div>

        <!-- שלב 5: אישור סיום (משודרג) -->
        <div id="step5" class="step">
            <div class="completion-header animate__animated animate__bounceIn">
                <i class="fas fa-check-circle completion-icon"></i>
                <h2>התהליך הושלם בהצלחה</h2>
                <p>הסיכום זמין להעתקה ולשימוש</p>
            </div>
            
            <div class="summary-box final-summary">
                <h3>הסיכום הרפואי שהופק:</h3>
                <div id="final-summary-text"></div>
                <div class="summary-actions">
                    <button id="copy-final-summary" class="copy-button">
                        <i class="fas fa-copy"></i> העתק סיכום
                    </button>
                    <button id="print-summary" class="print-button">
                        <i class="fas fa-print"></i> הדפס סיכום
                    </button>
                    <button id="export-pdf" class="export-button">
                        <i class="fas fa-file-pdf"></i> יצוא ל-PDF
                    </button>
                </div>
            </div>
            
            <div class="completion-actions">
                <button id="start-new" class="btn-primary">
                    <i class="fas fa-file"></i> התחל רשומה חדשה
                </button>
                
                <button id="view-history" class="btn-secondary">
                    <i class="fas fa-history"></i> צפה בהיסטוריה
                </button>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div id="toast-container"></div>

    <!-- כפתור מצב חשוך -->
    <button id="dark-mode-toggle" class="dark-mode-toggle floating">
        <i class="fas fa-moon"></i>
    </button>

    <!-- קישור לקבצי JavaScript -->
    <script>
        // קוד JavaScript מוטמע ישירות בעמוד
        // הוספת רכיבי מיקשק - הזו הגישה הבטוחה ביותר להתחלה

        // יצירת אובייקט המצב המרכזי
        const state = {
            currentStep: 1,
            patientRecord: {},
            darkMode: localStorage.getItem('darkMode') === 'true' || false,
            lastSelectedOptions: {},
            unsavedChanges: false,
            pendingSaves: [],
            cachedElements: new Map(),
            cachedQuestions: new Map(),
            searchDelay: null,
            isSearchActive: false
        };

        // האזנה לטעינת המסמך
        document.addEventListener('DOMContentLoaded', function() {
            initializeApplication();
        });

        // פונקציית אתחול ראשית
        function initializeApplication() {
            // הפעלת מצב תצוגה התחלתי
            document.body.setAttribute('data-theme', state.darkMode ? 'dark' : 'light');
            
            // עדכון סרגל התקדמות
            updateProgressBar();
            
            // אתחול אירועים לבחירת מגדר
            document.querySelectorAll('.gender-option').forEach(option => {
                option.addEventListener('click', function() {
                    // הסרת סימון מכל האפשרויות
                    document.querySelectorAll('.gender-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // סימון האפשרות שנבחרה
                    this.classList.add('selected');
                    
                    // עדכון ערך הקלט החבוי
                    const genderInput = document.getElementById('gender-value');
                    if (genderInput) {
                        genderInput.value = this.dataset.value;
                        state.unsavedChanges = true;
                    }
                });
            });
            
            // אתחול אירועים לבחירת פרופיל רפואי
            document.querySelectorAll('.profile-card').forEach(card => {
                card.addEventListener('click', function() {
                    // הסרת סימון מכל האפשרויות
                    document.querySelectorAll('.profile-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    
                    // סימון האפשרות שנבחרה
                    this.classList.add('selected');
                    
                    // עדכון ערך הקלט החבוי
                    const profileInput = document.getElementById('profile-value');
                    if (profileInput) {
                        profileInput.value = this.dataset.value;
                        state.unsavedChanges = true;
                    }
                });
            });
            
            // אתחול אירועים לרדיו אלרגיות
            document.querySelectorAll('input[name="allergies"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    toggleFieldVisibility('allergies', this.value === 'yes');
                    state.unsavedChanges = true;
                });
            });
            
            // אתחול אירועים לרדיו תרופות
            document.querySelectorAll('input[name="medications"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    toggleFieldVisibility('medications', this.value === 'yes');
                    state.unsavedChanges = true;
                });
            });
            
            // אתחול אירועים לרדיו עישון
            document.querySelectorAll('input[name="smoking"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    toggleFieldVisibility('smoking', this.value === 'yes');
                    state.unsavedChanges = true;
                });
            });
            
            // אתחול אירוע בחירת תלונה
            const complaintSelect = document.getElementById('main-complaint');
            if (complaintSelect) {
                complaintSelect.addEventListener('change', function() {
                    const otherContainer = document.getElementById('other-complaint-container');
                    if (this.value === 'אחר') {
                        otherContainer.style.display = 'block';
                    } else {
                        otherContainer.style.display = 'none';
                    }
                    
                    state.unsavedChanges = true;
                });
            }
            
            // אתחול כפתורי גיל מהירים
            document.querySelectorAll('.age-button').forEach(button => {
                button.addEventListener('click', function() {
                    const ageField = document.getElementById('patient-age');
                    if (ageField) {
                        ageField.value = this.textContent;
                        state.unsavedChanges = true;
                    }
                });
            });
            
            // כפתור מצב כהה
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', function() {
                    state.darkMode = !state.darkMode;
                    localStorage.setItem('darkMode', state.darkMode);
                    document.body.setAttribute('data-theme', state.darkMode ? 'dark' : 'light');
                    
                    // עדכון צלמית
                    this.innerHTML = state.darkMode ? 
                        '<i class="fas fa-sun"></i>' : 
                        '<i class="fas fa-moon"></i>';
                });
            }
            
            // אתחול מאזיני כפתורים
            initializeNavigationButtons();
        }

        // פונקציה להצגת שלב מסוים
        function showStep(stepNumber, skipConfirm = false) {
            // בדיקת שינויים לא שמורים
            if (!skipConfirm && state.unsavedChanges && state.currentStep !== stepNumber) {
                const confirmMove = confirm("יש לך שינויים שלא נשמרו. האם אתה בטוח שברצונך לעבור לשלב אחר?");
                if (!confirmMove) {
                    return;
                }
            }

            // הסתרת כל השלבים
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });

            // הצגת השלב הנבחר
            const currentStepElement = document.getElementById(`step${stepNumber}`);
            if (currentStepElement) {
                currentStepElement.classList.add('active');
            } else {
                console.error(`לא נמצא אלמנט עבור שלב ${stepNumber}`);
                return;
            }

            // שמירת השלב הנוכחי
            state.currentStep = stepNumber;

            // עדכון התצוגה
            updateProgressBar();
        }

        // פונקציית עדכון סרגל התקדמות
        function updateProgressBar() {
            const progressContainer = document.getElementById('progress-bar-container');
            if (!progressContainer) return;
            
            // יצירת תצוגת התקדמות
            const totalSteps = 5;
            let progressHTML = '<div class="progress-bar">';
            
            for (let i = 1; i <= totalSteps; i++) {
                let statusClass = '';
                if (i < state.currentStep) statusClass = 'completed';
                if (i === state.currentStep) statusClass = 'active';
                
                progressHTML += `<div class="progress-step ${statusClass}">${i}</div>`;
            }
            
            progressHTML += '</div>';
            progressContainer.innerHTML = progressHTML;
        }

        // פונקציה לטיפול בשדה בחירה (כן/לא) וחשיפת שדות נוספים
        function toggleFieldVisibility(fieldName, show) {
            const detailsContainer = document.getElementById(`${fieldName}-details-container`);
            if (!detailsContainer) return;
            
            detailsContainer.style.display = show ? 'block' : 'none';
            
            if (!show) {
                const detailsInput = document.getElementById(`${fieldName}-details`);
                if (detailsInput) detailsInput.value = '';
            }
        }

        // טיפול במעבר משלב 1 לשלב 2
        function handleStep1to2() {
            // איסוף נתוני הפרופיל הרפואי
            const profile = document.getElementById('profile-value').value;
            const medicalSections = document.getElementById('medical-sections').value.trim();
            
            // בדיקה והכנת אלרגיות
            const hasAllergies = document.querySelector('input[name="allergies"]:checked').value === 'yes';
            let allergiesDetails = "ללא אלרגיות ידועות";
            if (hasAllergies) {
                allergiesDetails = document.getElementById('allergies-details').value.trim();
                if (!allergiesDetails) {
                    showToast('error', 'נא לפרט את האלרגיות');
                    return;
                }
            }
            
            // בדיקה והכנת תרופות
            const takesMedications = document.querySelector('input[name="medications"]:checked').value === 'yes';
            let medicationsDetails = "לא נוטל תרופות באופן קבוע";
            if (takesMedications) {
                medicationsDetails = document.getElementById('medications-details').value.trim();
                if (!medicationsDetails) {
                    showToast('error', 'נא לפרט את התרופות');
                    return;
                }
            }
            
            // בדיקה והכנת עישון
            const isSmoking = document.querySelector('input[name="smoking"]:checked').value === 'yes';
            let smokingDetails = "לא מעשן";
            if (isSmoking) {
                smokingDetails = document.getElementById('smoking-details').value.trim();
                smokingDetails = smokingDetails ? `מעשן, ${smokingDetails}` : "מעשן";
            }
            
            // וידוא שכל השדות הנדרשים מולאו
            const age = document.getElementById('patient-age').value;
            const gender = document.getElementById('gender-value').value;
            const mainComplaintSelect = document.getElementById('main-complaint');
            let mainComplaint = mainComplaintSelect.value;
            
            // בדיקת תקינות הנתונים
            if (!age || age < 0 || age > 120) {
                showToast('error', 'יש להזין גיל תקין (0-120)');
                return;
            }
            
            if (!gender) {
                showToast('error', 'יש לבחור מין');
                return;
            }
            
            if (!mainComplaint) {
                showToast('error', 'יש לבחור תלונה עיקרית');
                return;
            }
            
            // אם נבחר "אחר", לקחת את הערך מהשדה הנוסף
            if (mainComplaint === 'אחר') {
                const otherComplaint = document.getElementById('other-complaint').value.trim();
                if (!otherComplaint) {
                    showToast('error', 'יש לפרט את התלונה האחרת');
                    return;
                }
                mainComplaint = otherComplaint;
            }
            
            // יצירת רשומת מטופל חדשה
            state.patientRecord = {
                patientInfo: {
                    age: parseInt(age),
                    gender: gender,
                    mainComplaint: mainComplaint,
                    timestamp: new Date().toISOString(),
                    profile: profile,
                    medicalSections: medicalSections || "ללא סעיפים",
                    allergies: hasAllergies ? allergiesDetails : "ללא אלרגיות ידועות",
                    medications: takesMedications ? medicationsDetails : "לא נוטל תרופות באופן קבוע",
                    smoking: isSmoking ? "yes" : "no"
                },
                standardAnswers: {},
                dynamicAnswers: {},
                vitalSigns: {},
                summary: ""
            };
            
            // הצגת שאלות סטנדרטיות בהתאם לתלונה
            const standardQuestions = getStandardQuestions(mainComplaint);
            
            // הכנת רשימת השאלות הסטנדרטיות
            const questionsList = document.getElementById('standard-questions-list');
            questionsList.innerHTML = '';
            
            if (standardQuestions.length === 0) {
                // אם אין שאלות סטנדרטיות לתלונה זו
                const noQuestionsItem = document.createElement('li');
                noQuestionsItem.className = 'question-item';
                noQuestionsItem.textContent = 'אין שאלות סטנדרטיות לתלונה זו. נא לעבור לשלב הבא.';
                questionsList.appendChild(noQuestionsItem);
            } else {
                // הוספת השאלות הסטנדרטיות
                standardQuestions.forEach((question, index) => {
                    const questionElement = createQuestionElement(question, index, true);
                    questionsList.appendChild(questionElement);
                });
            }
            
            // מעבר לשלב הבא
            showStep(2);
        }

        // פונקציה עבור שלב 2 ל-3
        function handleStep2to3() {
            // איסוף תשובות מהשאלות הסטנדרטיות
            const standardAnswers = collectAnswers('input[data-standard="true"], select[data-standard="true"], textarea[data-standard="true"], input[type="hidden"][data-standard="true"]');
            
            // שמירת התשובות ברשומת המטופל
            state.patientRecord.standardAnswers = standardAnswers;
            
            // הצגת אנימציית טעינה
            document.getElementById('dynamic-questions-loading').style.display = 'block';
            document.getElementById('dynamic-questions-container').style.display = 'none';
            
            // מעבר לשלב הבא
            showStep(3);
            
            // הצגת שאלות דינמיות
            setTimeout(() => {
                // קבלת שאלות דינמיות לפי התלונה והתשובות הקודמות
                const dynamicQuestions = getLocalDynamicQuestions(
                    state.patientRecord.patientInfo.mainComplaint,
                    standardAnswers
                );
                
                // הצגת השאלות הדינמיות
                renderDynamicQuestions(dynamicQuestions);
                
                // הסתרת אנימציית הטעינה
                document.getElementById('dynamic-questions-loading').style.display = 'none';
                document.getElementById('dynamic-questions-container').style.display = 'block';
            }, 1000);
        }

        // פונקציה לאיסוף תשובות
        function collectAnswers(selector) {
            const answers = {};
            const inputs = document.querySelectorAll(selector);
            
            inputs.forEach(input => {
                // דילוג על שדות ריקים
                if (!input.value && !input.checked) {
                    return;
                }
                
                // אם אין שאלה, לא נוסיף לתשובות
                if (!input.dataset.question) {
                    return;
                }

                // קבלת הערך בהתאם לסוג הפקד
                let value = '';
                
                if (input.type === 'hidden') {
                    // שדות מיוחדים (סקאלה, בחירה מרובה)
                    value = input.value;
                } else if (input.type === 'radio') {
                    // דילוג על פקדי רדיו לא מסומנים
                    if (!input.checked) return;
                    
                    value = input.value;
                    
                    // טיפול מיוחד בתשובת "כן" עם שדה מעקב
                    if (value === 'כן') {
                        const followUpSelector = `.follow-up-input[data-parent-question="${input.dataset.question}"]`;
                        const followUpInput = document.querySelector(followUpSelector);
                        if (followUpInput && followUpInput.value.trim() !== '') {
                            value = `כן, ${followUpInput.value.trim()}`;
                        }
                    }
                } else if (input.tagName === 'SELECT') {
                    value = input.value;
                } else if (input.tagName === 'TEXTAREA' || input.type === 'text') {
                    value = input.value.trim();
                } else {
                    value = input.value.trim();
                }
                
                // הוספת הערך למילון התשובות
                if (value !== '') {
                    answers[input.dataset.question] = value;
                }
            });
            
            return answers;
        }

        // מעבר משלב 3 לשלב 4
        function handleStep3to4() {
            // איסוף תשובות לשאלות דינמיות
            const dynamicAnswers = collectAnswers('input[data-dynamic="true"], select[data-dynamic="true"], textarea[data-dynamic="true"], input[type="hidden"][data-dynamic="true"]');
            
            // שמירת התשובות ברשומת המטופל
            state.patientRecord.dynamicAnswers = dynamicAnswers;
            
            // הצגת אנימציית טעינה
            document.getElementById('summary-loading').style.display = 'block';
            document.getElementById('summary-container').style.display = 'none';
            
            // מעבר לשלב הבא
            showStep(4);
            
            // יצירת סיכום אנמנזה (סימולציה פשוטה)
            setTimeout(() => {
                // יצירת סיכום פשוט
                const summary = createDetailedMedicalSummary(state.patientRecord);
                state.patientRecord.summary = summary;
                
                // הצגת הסיכום במסך
                document.getElementById('summary-text').textContent = summary;
                
                // הסתרת אנימציית הטעינה והצגת הסיכום
                document.getElementById('summary-loading').style.display = 'none';
                document.getElementById('summary-container').style.display = 'block';
            }, 1500);
        }

        // סיום והצגת שלב 5
        function handleCompleteSummary() {
            // העבר ישירות לשלב 5 (סיום)
            document.getElementById('final-summary-text').textContent = state.patientRecord.summary;
            
            showStep(5);
            
            // איפוס דגל השינויים
            state.unsavedChanges = false;
        }

        // פונקציה להצגת הודעות toast
        function showToast(type, message, duration = 3000) {
            // יצירת הודעה חדשה
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            
            // בחירת אייקון מתאים
            let icon = '';
            switch (type) {
                case 'success': icon = '<i class="fas fa-check-circle"></i>'; break;
                case 'error': icon = '<i class="fas fa-exclamation-circle"></i>'; break;
                case 'warning': icon = '<i class="fas fa-exclamation-triangle"></i>'; break;
                case 'info': icon = '<i class="fas fa-info-circle"></i>'; break;
                case 'sending': icon = '<i class="fas fa-spinner fa-spin"></i>'; break;
            }
            
            toast.innerHTML = `${icon} ${message}`;
            
            // הוספת ההודעה למסמך
            const container = document.getElementById('toast-container');
            if (container) {
                container.appendChild(toast);
            } else {
                document.body.appendChild(toast);
            }
            
            // הסרת ההודעה אחרי הזמן שהוגדר
            setTimeout(() => {
                toast.classList.add('fadeOut');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
            
            return toast;
        }

        // פונקציה לאתחול כפתורי ניווט
        function initializeNavigationButtons() {
            // שלב 1 -> שלב 2
            document.getElementById('next-to-step2').addEventListener('click', handleStep1to2);
            
            // שלב 2 -> שלב 1
            document.getElementById('back-to-step1').addEventListener('click', function() {
                showStep(1);
            });
            
            // שלב 2 -> שלב 3
            document.getElementById('next-to-step3').addEventListener('click', handleStep2to3);
            
            // שלב 3 -> שלב 2
            document.getElementById('back-to-step2').addEventListener('click', function() {
                showStep(2);
            });
            
            // שלב 3 -> שלב 4
            document.getElementById('next-to-step4').addEventListener('click', handleStep3to4);
            
            // שלב 4 -> שלב 3
            document.getElementById('back-to-step3').addEventListener('click', function() {
                showStep(3);
            });
            
            // כפתור העתקת הסיכום
            document.getElementById('copy-summary').addEventListener('click', function() {
                const summaryText = document.getElementById('summary-text').textContent;
                navigator.clipboard.writeText(summaryText)
                    .then(() => {
                        showToast('success', 'הסיכום הועתק בהצלחה');
                    })
                    .catch(err => {
                        showToast('error', 'שגיאה בהעתקה. נסה שוב.');
                    });
            });
            
            // כפתור סיום
            document.getElementById('complete-summary').addEventListener('click', handleCompleteSummary);
            
            // כפתור שליחה לרופא
            document.getElementById('send-summary').addEventListener('click', function() {
                const doctorEmail = document.getElementById('doctor-email').value.trim();
                
                if (doctorEmail) {
                    showToast('info', `שולח סיכום לכתובת ${doctorEmail}...`);
                    setTimeout(() => {
                        showToast('success', `הסיכום נשלח בהצלחה לכתובת: ${doctorEmail}`);
                        handleCompleteSummary();
                    }, 1500);
                } else {
                    handleCompleteSummary();
                }
            });
            
            // כפתור העתקת הסיכום הסופי
            document.getElementById('copy-final-summary').addEventListener('click', function() {
                const summaryText = document.getElementById('final-summary-text').textContent;
                navigator.clipboard.writeText(summaryText)
                    .then(() => {
                        showToast('success', 'הסיכום הועתק בהצלחה');
                    })
                    .catch(err => {
                        showToast('error', 'שגיאה בהעתקה. נסה שוב.');
                    });
            });
            
            // כפתור התחלת רשומה חדשה
            document.getElementById('start-new').addEventListener('click', function() {
                resetForm();
                showStep(1, true);
            });
        }

        // פונקציית איפוס הטופס
        function resetForm() {
            // איפוס שדות פרופיל בסיסיים
            document.getElementById('patient-age').value = '';
            
            document.querySelectorAll('.gender-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector('.gender-option[data-value="male"]').classList.add('selected');
            document.getElementById('gender-value').value = 'male';
            
            document.getElementById('main-complaint').selectedIndex = 0;
            document.getElementById('other-complaint').value = '';
            document.getElementById('other-complaint-container').style.display = 'none';
            
            // איפוס פרופיל רפואי
            document.querySelectorAll('.profile-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector('.profile-card[data-value="97"]').classList.add('selected');
            document.getElementById('profile-value').value = '97';
            
            document.getElementById('medical-sections').value = '';
            
            // איפוס אלרגיות, תרופות ועישון
            document.querySelector('input[name="allergies"][value="no"]').checked = true;
            document.querySelector('input[name="medications"][value="no"]').checked = true;
            document.querySelector('input[name="smoking"][value="no"]').checked = true;
            
            document.getElementById('allergies-details-container').style.display = 'none';
            document.getElementById('medications-details-container').style.display = 'none';
            document.getElementById('smoking-details-container').style.display = 'none';
            
            document.getElementById('allergies-details').value = '';
            document.getElementById('medications-details').value = '';
            document.getElementById('smoking-details').value = '';
            
            // איפוס המצב הכללי
            state.patientRecord = {};
            state.unsavedChanges = false;
            
            showToast('info', 'הטופס אופס בהצלחה');
        }

        // פונקציה לקבלת שאלות סטנדרטיות
        function getStandardQuestions(complaint) {
            // תלונות נפוצות ושאלות מתאימות
            const standardQuestionsMap = {
                "כאב גרון": [
                    {
                        type: "duration",
                        question: "כמה זמן נמשך הכאב בגרון?",
                        placeholder: "יום / יומיים / שבוע..."
                    },
                    {
                        type: "yesNo",
                        question: "האם יש לך חום?",
                        followUp: "מה גובה החום ומתי נמדד לאחרונה?"
                    },
                    {
                        type: "multiselect",
                        question: "סימפטומים נלווים",
                        options: ["שיעול", "נזלת", "גודש באף", "כאב באוזניים", "צרידות", "קשיי בליעה"]
                    }
                ],
                "כאב ראש": [
                    {
                        type: "duration",
                        question: "כמה זמן נמשך כאב הראש?",
                        placeholder: "שעות / ימים / שבועות"
                    },
                    {
                        type: "multiselect",
                        question: "היכן ממוקם הכאב?",
                        options: ["מצח", "רקות", "עורף", "צד ימין", "צד שמאל", "כל הראש"]
                    },
                    {
                        type: "yesNo",
                        question: "האם יש לך בחילה?",
                        followUp: "מתי מופיעה הבחילה?"
                    }
                ],
                "כאב בטן": [
                    {
                        type: "duration",
                        question: "כמה זמן נמשך כאב הבטן?",
                        placeholder: "שעות / ימים / שבועות"
                    },
                    {
                        type: "multiselect",
                        question: "היכן ממוקם הכאב?",
                        options: ["בטן עליונה", "בטן תחתונה", "צד ימין", "צד שמאל", "סביב הטבור", "כל הבטן"]
                    },
                    {
                        type: "yesNo",
                        question: "האם יש שינויים ביציאות?",
                        followUp: "איזה סוג של שינויים (שלשול/עצירות)?"
                    }
                ],
                "default": [
                    {
                        type: "duration",
                        question: "כמה זמן נמשכים הסימפטומים?",
                        placeholder: "שעות / ימים / שבועות..."
                    },
                    {
                        type: "yesNo",
                        question: "האם ניסית טיפול כלשהו עד כה?",
                        followUp: "איזה טיפול והאם הועיל?"
                    }
                ]
            };
            
            // בחירת שאלות מתאימות לתלונה
            let questionsKey = "default";
            
            if (complaint.includes("ראש")) {
                questionsKey = "כאב ראש";
            } else if (complaint.includes("בטן")) {
                questionsKey = "כאב בטן";
            } else if (complaint.includes("גרון")) {
                questionsKey = "כאב גרון";
            }
            
            return standardQuestionsMap[questionsKey] || standardQuestionsMap["default"];
        }

        // פונקציה לקבלת שאלות דינמיות מקומיות
        function getLocalDynamicQuestions(complaint, previousAnswers) {
            // מיפוי שאלות דינמיות
            const dynamicQuestionsMap = {
                "כאב ראש": [
                    {
                        type: "yesNo",
                        question: "האם יש הפרעות ראייה?",
                        followUp: "איזה סוג של הפרעות (טשטוש, כפל ראייה)?"
                    },
                    {
                        type: "yesNo",
                        question: "האם כאב הראש מעיר אותך משינה?",
                        followUp: "באיזו תדירות?"
                    }
                ],
                "כאב בטן": [
                    {
                        type: "yesNo",
                        question: "האם הכאב קשור לאכילה?",
                        followUp: "האם מופיע לפני, בזמן או אחרי אכילה?"
                    },
                    {
                        type: "yesNo",
                        question: "האם יש שינוי בצבע היציאות?",
                        followUp: "מהו הצבע?"
                    }
                ],
                "default": [
                    {
                        type: "multiselect",
                        question: "האם חל שינוי ברמת האנרגיה שלך לאחרונה?",
                        options: ["ירידה באנרגיה", "עייפות מוגברת", "קשיי שינה", "חוסר מנוחה", "אין שינוי"]
                    },
                    {
                        type: "yesNo",
                        question: "האם חווית מצבים דומים בעבר?",
                        followUp: "מתי והאם טופלו?"
                    }
                ]
            };
            
            // בחירת שאלות מתאימות
            let questionsKey = "default";
            
            if (complaint.includes("ראש")) {
                questionsKey = "כאב ראש";
            } else if (complaint.includes("בטן")) {
                questionsKey = "כאב בטן";
            }
            
            // החזרת השאלות המתאימות או ברירת מחדל
            return dynamicQuestionsMap[questionsKey] || dynamicQuestionsMap["default"];
        }

        // פונקציה ליצירת אלמנט שאלה
        function createQuestionElement(questionData, index, isStandard = true) {
            // יצירת מיכל השאלה
            const container = document.createElement('li');
            container.className = 'question-item fade-in';
            container.dataset.index = index;
            container.dataset.type = questionData.type;
            container.dataset.isStandard = isStandard;
            
            // ראש השאלה
            const questionHeader = document.createElement('div');
            questionHeader.className = 'question-header';
            questionHeader.textContent = questionData.question;
            
            // אזור התשובה
            const answerContainer = document.createElement('div');
            answerContainer.className = 'answer-container';
            
            // מזהה ייחודי לשאלה
            const questionId = `question-${index}-${isStandard ? 'std' : 'dyn'}`;
            
            // בניית רכיב התשובה לפי סוג השאלה
            switch (questionData.type) {
                case 'yesNo':
                    createYesNoInput(answerContainer, questionData, questionId, index, isStandard);
                    break;
                case 'multiselect':
                    createMultiSelectInput(answerContainer, questionData, questionId, index, isStandard);
                    break;
                case 'duration':
                case 'value':
                case 'quantity':
                    createTextInput(answerContainer, questionData, questionId, index, isStandard);
                    break;
                case 'multiline':
                    createTextareaInput(answerContainer, questionData, questionId, index, isStandard);
                    break;
                default:
                    // ברירת מחדל - שדה טקסט רגיל
                    createTextInput(answerContainer, questionData, questionId, index, isStandard);
                    break;
            }
            
            // הרכבת מבנה השאלה
            container.appendChild(questionHeader);
            container.appendChild(answerContainer);
            
            return container;
        }

        // פונקציה ליצירת רכיב תשובה כן/לא
        function createYesNoInput(container, questionData, questionId, index, isStandard) {
            const radioGroup = document.createElement('div');
            radioGroup.className = 'radio-group question-radio-group';
            
            // אפשרות "כן"
            const yesLabel = document.createElement('label');
            yesLabel.className = 'radio-option radio-yes';
            
            const yesInput = document.createElement('input');
            yesInput.type = 'radio';
            yesInput.id = `${questionId}-yes`;
            yesInput.name = questionId;
            yesInput.value = 'כן';
            yesInput.dataset.question = questionData.question;
            yesInput.dataset.index = index;
            yesInput.dataset.type = 'yesNo';
            
            if (isStandard) {
                yesInput.dataset.standard = 'true';
            } else {
                yesInput.dataset.dynamic = 'true';
            }
            
            yesInput.addEventListener('change', function() {
                if (this.checked) {
                    highlightSelectedOption(this.parentElement, true);
                    
                    // הצגת שדה מעקב אם קיים
                    const followUpContainer = container.querySelector('.follow-up-container');
                    if (followUpContainer) {
                        followUpContainer.style.display = 'block';
                    }
                }
            });
            
            yesLabel.appendChild(yesInput);
            yesLabel.appendChild(document.createTextNode('כן'));
            
            // אפשרות "לא"
            const noLabel = document.createElement('label');
            noLabel.className = 'radio-option radio-no';
            
            const noInput = document.createElement('input');
            noInput.type = 'radio';
            noInput.id = `${questionId}-no`;
            noInput.name = questionId;
            noInput.value = 'לא';
            noInput.dataset.question = questionData.question;
            noInput.dataset.index = index;
            noInput.dataset.type = 'yesNo';
            
            if (isStandard) {
                noInput.dataset.standard = 'true';
            } else {
                noInput.dataset.dynamic = 'true';
            }
            
            noInput.addEventListener('change', function() {
                if (this.checked) {
                    highlightSelectedOption(this.parentElement, true);
                    
                    // הסתרת שדה מעקב אם קיים
                    const followUpContainer = container.querySelector('.follow-up-container');
                    if (followUpContainer) {
                        followUpContainer.style.display = 'none';
                    }
                }
            });
            
            noLabel.appendChild(noInput);
            noLabel.appendChild(document.createTextNode('לא'));
            
            radioGroup.appendChild(yesLabel);
            radioGroup.appendChild(noLabel);
            container.appendChild(radioGroup);
            
            // הוספת שדה מעקב נוסף לתשובת "כן" אם נדרש
            if (questionData.followUp) {
                const followUpContainer = document.createElement('div');
                followUpContainer.className = 'follow-up-container';
                followUpContainer.style.display = 'none';
                
                const followUpInput = document.createElement('input');
                followUpInput.type = 'text';
                followUpInput.className = 'follow-up-input';
                followUpInput.placeholder = questionData.followUp;
                followUpInput.dataset.parentQuestion = questionData.question;
                
                if (isStandard) {
                    followUpInput.dataset.standard = 'true';
                } else {
                    followUpInput.dataset.dynamic = 'true';
                }
                
                followUpContainer.appendChild(followUpInput);
                container.appendChild(followUpContainer);
            }
        }

        // פונקציה ליצירת רכיב בחירה מרובה
        function createMultiSelectInput(container, questionData, questionId, index, isStandard) {
            const multiSelectContainer = document.createElement('div');
            multiSelectContainer.className = 'multiselect-container';
            
            // יצירת שדה חבוי לשמירת הערך המרובה
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.className = `${questionData.type}-value`;
            hiddenInput.dataset.question = questionData.question;
            hiddenInput.dataset.index = index;
            hiddenInput.dataset.type = questionData.type;
            
            if (isStandard) {
                hiddenInput.dataset.standard = 'true';
            } else {
                hiddenInput.dataset.dynamic = 'true';
            }
            
            // יצירת תיבות סימון לאפשרויות
            if (questionData.options && Array.isArray(questionData.options)) {
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'checkbox-group';
                
                // יצירת האפשרויות
                questionData.options.forEach(option => {
                    const optionLabel = document.createElement('label');
                    optionLabel.className = 'checkbox-option';
                    
                    const optionInput = document.createElement('input');
                    optionInput.type = 'checkbox';
                    optionInput.value = option;
                    optionInput.dataset.question = questionData.question;
                    optionInput.dataset.option = option;
                    optionInput.dataset.type = questionData.type;
                    
                    if (isStandard) {
                        optionInput.dataset.standard = 'true';
                    } else {
                        optionInput.dataset.dynamic = 'true';
                    }
                    
                    optionInput.addEventListener('change', function() {
                        highlightSelectedOption(this.parentElement, this.checked);
                        updateMultiSelectValue(questionData.question, questionData.type, multiSelectContainer);
                    });
                    
                    optionLabel.appendChild(optionInput);
                    optionLabel.appendChild(document.createTextNode(option));
                    optionsContainer.appendChild(optionLabel);
                });
                
                multiSelectContainer.appendChild(optionsContainer);
            }
            
            multiSelectContainer.appendChild(hiddenInput);
            container.appendChild(multiSelectContainer);
        }

        // פונקציה ליצירת שדה קלט טקסט
        function createTextInput(container, questionData, questionId, index, isStandard) {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'answer-input';
            input.placeholder = questionData.placeholder || 'הזן תשובה...';
            input.dataset.question = questionData.question;
            input.dataset.index = index;
            input.dataset.type = questionData.type;
            
            if (isStandard) {
                input.dataset.standard = 'true';
            } else {
                input.dataset.dynamic = 'true';
            }
            
            container.appendChild(input);
        }

        // פונקציה ליצירת שדה קלט טקסט רב-שורתי
        function createTextareaInput(container, questionData, questionId, index, isStandard) {
            const textarea = document.createElement('textarea');
            textarea.className = 'answer-textarea';
            textarea.rows = 4;
            textarea.placeholder = questionData.placeholder || 'הזן תשובה מפורטת...';
            textarea.dataset.question = questionData.question;
            textarea.dataset.index = index;
            textarea.dataset.type = 'multiline';
            
            if (isStandard) {
                textarea.dataset.standard = 'true';
            } else {
                textarea.dataset.dynamic = 'true';
            }
            
            container.appendChild(textarea);
        }

        // פונקציה לעדכון תצוגת אפשרות נבחרת
        function highlightSelectedOption(optionElement, isSelected) {
            if (isSelected) {
                optionElement.classList.add('selected');
            } else {
                optionElement.classList.remove('selected');
            }
        }

        // פונקציה לעדכון ערך בחירה מרובה
        function updateMultiSelectValue(question, type, container) {
            const hiddenInput = container.querySelector(`.${type}-value`);
            if (!hiddenInput) return;
            
            const options = [];
            
            // איסוף אפשרויות רגילות שנבחרו
            container.querySelectorAll(`input[type="checkbox"][data-option]`).forEach(checkbox => {
                if (checkbox.checked) {
                    options.push(checkbox.dataset.option);
                }
            });
            
            // עדכון ערך הקלט החבוי
            hiddenInput.value = options.join(', ');
        }

        // פונקציה להצגת שאלות דינמיות
        function renderDynamicQuestions(dynamicQuestions) {
            const questionsList = document.getElementById('dynamic-questions-list');
            questionsList.innerHTML = '';
            
            if (!dynamicQuestions || dynamicQuestions.length === 0) {
                // אם אין שאלות דינמיות
                const noQuestionsItem = document.createElement('li');
                noQuestionsItem.className = 'question-item';
                noQuestionsItem.textContent = 'אין שאלות נוספות לתלונה זו. נא לעבור לשלב הבא.';
                questionsList.appendChild(noQuestionsItem);
            } else {
                // הוספת השאלות הדינמיות
                dynamicQuestions.forEach((question, index) => {
                    const questionElement = createQuestionElement(question, index, false);
                    questionsList.appendChild(questionElement);
                });
            }
            
            // הוספת שדה טקסט חופשי לסוף השאלון
            const freeTextContainer = document.createElement('div');
            freeTextContainer.className = 'free-notes-container';
            
            const freeTextTitle = document.createElement('h3');
            freeTextTitle.textContent = 'מידע נוסף';
            
            const freeTextArea = document.createElement('textarea');
            freeTextArea.className = 'free-text-area';
            freeTextArea.rows = 5;
            freeTextArea.placeholder = 'הוסף כל מידע נוסף שלא נכלל בשאלות הקודמות...';
            freeTextArea.dataset.question = 'מידע נוסף';
            freeTextArea.dataset.dynamic = 'true';
            freeTextArea.dataset.type = 'multiline';
            
            freeTextContainer.appendChild(freeTextTitle);
            freeTextContainer.appendChild(freeTextArea);
            
            questionsList.appendChild(freeTextContainer);
        }

        // פונקציה ליצירת סיכום רפואי מפורט
        function createDetailedMedicalSummary(patientRecord) {
            try {
                // חילוץ מידע בסיסי
                const { age, gender, mainComplaint, profile, medicalSections, allergies, medications, smoking } = patientRecord.patientInfo;
                const genderText = gender === 'male' ? 'זכר' : 'נקבה';
                const smokingText = smoking === 'yes' ? 'מעשן/ת' : 'לא מעשן/ת';
                
                // פתיחת האנמנזה עם פרטי הפרופיל הרפואי
                let summary = `פרופיל ${profile}, ${medicalSections || "ללא סעיפים"}, ${allergies || "ללא אלרגיות ידועות"}, ${medications || "לא נוטל/ת תרופות באופן קבוע"}.\n\n`;
                
                // תיאור דמוגרפי ותלונה עיקרית
                summary += `מטופל/ת בן/בת ${age}, ${genderText}, ${smokingText}, פונה עם תלונה עיקרית של ${mainComplaint}.`;
                
                // בניית תיאור של התשובות הסטנדרטיות
                if (patientRecord.standardAnswers && Object.keys(patientRecord.standardAnswers).length > 0) {
                    summary += "\n\nפרטים נוספים: ";
                    const standardDetails = [];
                    
                    for (const [question, answer] of Object.entries(patientRecord.standardAnswers)) {
                        standardDetails.push(`${question.replace('?', '')}: ${answer}`);
                    }
                    
                    summary += standardDetails.join('; ');
                }
                
                // הוספת תשובות דינמיות
                if (patientRecord.dynamicAnswers && Object.keys(patientRecord.dynamicAnswers).length > 0) {
                    summary += "\n\nמידע משלים: ";
                    const dynamicDetails = [];
                    
                    for (const [question, answer] of Object.entries(patientRecord.dynamicAnswers)) {
                        dynamicDetails.push(`${question.replace('?', '')}: ${answer}`);
                    }
                    
                    summary += dynamicDetails.join('; ');
                }
                
                return summary;
            } catch (error) {
                console.error("שגיאה ביצירת סיכום:", error);
                return `מטופל/ת בן/בת ${patientRecord.patientInfo.age}, פונה עם תלונה עיקרית של ${patientRecord.patientInfo.mainComplaint}.`;
            }
        }
    </script>
</body>
</html>